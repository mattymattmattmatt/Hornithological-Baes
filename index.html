<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hornithological Baes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050816;--bg-elevated:#0d1022;--accent:#4f46e5;--accent-soft:rgba(79,70,229,.15);
      --accent-strong:rgba(129,140,248,.35);--text-main:#f9fafb;--text-muted:#9ca3af;
      --border-subtle:rgba(148,163,184,.25);--danger:#ef4444;--radius-lg:18px;--radius-md:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,.65);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:radial-gradient(circle at top left,#1d2446 0,transparent 55%),
                 radial-gradient(circle at bottom right,#164e63 0,transparent 55%),
                 var(--bg);
      color:var(--text-main);min-height:100vh;
    }
    .app-shell{max-width:1120px;margin:0 auto;padding:28px 16px 40px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
    .title-block{display:flex;flex-direction:column;gap:8px}
    .title-row{display:flex;align-items:center;gap:12px}
    .logo{
      height:132px;
      width:auto;border-radius:12px;object-fit:contain;background:rgba(15,23,42,.7);
      padding:4px 8px;border:1px solid rgba(148,163,184,.4);
    }
    .title-block h1{margin:0;font-size:1.9rem;letter-spacing:.03em;display:flex;align-items:center;gap:.45rem}
    .title-pill{
      font-size:.78rem;text-transform:uppercase;letter-spacing:.17em;color:var(--accent-soft);
      background:rgba(15,23,42,.72);border-radius:999px;padding:4px 10px;border:1px solid rgba(148,163,184,.4);
      display:inline-flex;align-items:center;gap:6px;
    }
    .title-pill-dot{width:8px;height:8px;border-radius:999px;background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.25)}
    .title-block p{margin:0;font-size:.9rem;color:var(--text-muted)}
    .layout{display:grid;grid-template-columns:minmax(0,340px) minmax(0,1fr);gap:20px}
    @media (max-width:900px){header{flex-direction:column;align-items:flex-start}.layout{grid-template-columns:minmax(0,1fr)}}
    .card{
      background:radial-gradient(circle at top,rgba(148,163,184,.12) 0,transparent 55%),var(--bg-elevated);
      border-radius:var(--radius-lg);padding:18px 18px 16px;box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(18px);
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .card-header h2{margin:0;font-size:1rem;letter-spacing:.08em;text-transform:uppercase;color:#e5e7eb}
    .badge-soft{font-size:.74rem;padding:3px 8px;border-radius:999px;background:var(--accent-soft);color:#c7d2fe;border:1px solid var(--accent-strong)}
    .dropzone{
      position:relative;border-radius:var(--radius-md);border:1px dashed rgba(148,163,184,.55);padding:18px;
      background:radial-gradient(circle at top left,rgba(79,70,229,.16) 0,transparent 55%),rgba(15,23,42,.85);
      display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;
      transition:border .15s ease,background .15s ease,transform .08s ease;cursor:pointer;
    }
    .dropzone.dragover{
      border-color:#a5b4fc;background:radial-gradient(circle at top left,rgba(79,70,229,.45) 0,transparent 65%),rgba(15,23,42,.96);
      transform:translateY(-1px);
    }
    .dropzone-icon{
      width:40px;height:40px;border-radius:16px;background:linear-gradient(145deg,rgba(129,140,248,.3),rgba(56,189,248,.25));
      display:flex;align-items:center;justify-content:center;margin-bottom:8px;box-shadow:0 14px 35px rgba(37,99,235,.5);
    }
    .dropzone-icon svg{width:21px;height:21px}
    .dropzone strong{font-size:.92rem}
    .dropzone p{margin:3px 0 0;font-size:.8rem;color:var(--text-muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;margin-top:10px;padding:3px 8px;border-radius:999px;background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);font-size:.78rem;color:var(--text-muted)}
    .chip-dot{width:6px;height:6px;border-radius:999px;background:#38bdf8}
    .hidden-input{display:none}
    .preview{margin-top:10px;display:flex;gap:10px;align-items:center}
    .preview img{width:70px;height:70px;object-fit:cover;border-radius:14px;border:1px solid rgba(148,163,184,.4)}
    .preview-text{font-size:.82rem;color:var(--text-muted)}
    .preview-text strong{color:#e5e7eb}
    .form-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:.8rem;text-transform:uppercase;letter-spacing:.15em;color:var(--text-muted)}
    .field input{
      border-radius:999px;border:1px solid var(--border-subtle);background:rgba(15,23,42,.9);padding:8px 12px;
      font-size:.9rem;color:var(--text-main);outline:none;transition:border .15s ease,box-shadow .15s ease,background .15s ease;
    }
    .field input:focus{border-color:#a5b4fc;box-shadow:0 0 0 1px rgba(129,140,248,.55);background:rgba(15,23,42,.98)}
    .species-input-row{display:flex;gap:8px;align-items:center}
    .species-input-row input{flex:1;cursor:pointer}
    .checklist-btn{
      border-radius:999px;border:1px solid rgba(129,140,248,.7);background:rgba(79,70,229,.16);color:#c7d2fe;
      font-size:.78rem;padding:6px 10px;cursor:pointer;white-space:nowrap;
    }
    .checklist-btn:hover{background:rgba(79,70,229,.26)}
    .actions-row{margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .text-muted{font-size:.78rem;color:var(--text-muted)}
    .btn-primary{
      appearance:none;border:none;border-radius:999px;padding:8px 16px;font-size:.9rem;font-weight:600;
      background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 12px 28px rgba(37,99,235,.55);transition:transform .08s ease,box-shadow .08s ease,filter .12s ease;
    }
    .btn-primary span{font-size:1rem}
    .btn-primary:disabled{opacity:.6;cursor:default;box-shadow:none;transform:none}
    .btn-primary:not(:disabled):hover{transform:translateY(-1px);filter:brightness(1.06);box-shadow:0 16px 36px rgba(37,99,235,.75)}
    .error-message{margin-top:6px;font-size:.78rem;color:#fecaca}
    .success-message{margin-top:6px;font-size:.78rem;color:#bbf7d0}
    .gallery-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px}
    .gallery-header h2{margin:0;font-size:1rem;text-transform:uppercase;letter-spacing:.11em}
    .gallery-header small{font-size:.8rem;color:var(--text-muted)}
    .filter-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .filter-badge{font-size:.76rem;padding:3px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.4);color:var(--text-muted);background:rgba(15,23,42,.9)}
    .gallery-empty{padding:16px 12px 12px;border-radius:var(--radius-md);background:rgba(15,23,42,.85);border:1px dashed rgba(148,163,184,.45);
      text-align:center;font-size:.86rem;color:var(--text-muted)}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
    .photo-card{
      background:radial-gradient(circle at top,rgba(79,70,229,.18) 0,transparent 55%),rgba(15,23,42,.96);
      border-radius:16px;border:1px solid rgba(148,163,184,.3);overflow:hidden;display:flex;flex-direction:column;min-height:230px;
    }
    .photo-thumb{position:relative;padding-top:66%;overflow:hidden}
    .photo-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform-origin:center;transition:transform .2s ease-out}
    .photo-card:hover .photo-thumb img{transform:scale(1.03)}
    .photo-chip{
      position:absolute;left:8px;bottom:8px;background:rgba(15,23,42,.82);padding:4px 8px;border-radius:999px;font-size:.72rem;color:var(--text-muted);
      display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(148,163,184,.6);
    }
    .photo-chip span.dot{width:6px;height:6px;border-radius:999px;background:#facc15}

    /* Status badges (rarity + abundance) */
    .status-badge{
      position:absolute;top:8px;right:8px;border-radius:999px;padding:3px 9px;font-size:.72rem;
      display:inline-flex;align-items:center;gap:6px;border:1px solid rgba(248,250,252,.8);
      backdrop-filter:blur(8px);box-shadow:0 10px 25px rgba(15,23,42,.7);color:#f9fafb;
    }
    .status-badge .icon{font-size:.92rem;line-height:1}
    .status-super-rare{background:linear-gradient(135deg,#f97316,#ec4899)}
    .status-rare{background:linear-gradient(135deg,#22c55e,#06b6d4)}
    .status-uncommon{background:linear-gradient(135deg,#a855f7,#3b82f6)}
    .status-common{background:linear-gradient(135deg,#10b981,#22c55e)}
    .status-very-common{background:linear-gradient(135deg,#f59e0b,#f97316)}

    .photo-body{padding:10px 11px 9px;display:flex;flex-direction:column;gap:5px;flex-grow:1}
    .photo-title{font-size:.95rem;font-weight:600;color:#e5e7eb}
    .photo-uploaded-by{font-size:.78rem;color:var(--text-muted)}
    .photo-location-row{display:flex;justify-content:space-between;gap:6px;align-items:center}
    .photo-location{font-size:.8rem;color:var(--text-muted)}
    .repeat-species-tag{font-size:.75rem;color:#a5b4fc;background:rgba(79,70,229,.16);border-radius:999px;padding:2px 8px;border:1px solid rgba(129,140,248,.5);white-space:nowrap}
    .photo-meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:2px;gap:6px}
    .rating-wrapper{display:flex;flex-direction:column;gap:3px}
    .parrots{display:inline-flex;gap:1px;flex-wrap:wrap;font-size:.9rem}
    .parrot{opacity:.2;transition:opacity .15s ease}
    .parrot.filled{opacity:1}
    .rating-text{font-size:.75rem;color:var(--text-muted)}
    .time-tag{font-size:.76rem;color:var(--text-muted);padding:4px 9px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.4)}
    .card-footer-row{display:flex;justify-content:space-between;margin-top:6px;gap:8px;align-items:center}
    .rate-btn{border:none;border-radius:999px;padding:4px 10px;font-size:.75rem;cursor:pointer;background:rgba(79,70,229,.18);color:#c7d2fe;border:1px solid rgba(129,140,248,.6)}
    .rate-btn:hover{background:rgba(79,70,229,.28)}
    .delete-btn{border:none;border-radius:999px;padding:4px 10px;font-size:.75rem;cursor:pointer;background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(248,113,113,.5);display:inline-flex;align-items:center;gap:6px}
    .delete-btn:hover{background:rgba(239,68,68,.22)}
    footer{margin-top:18px;font-size:.78rem;color:var(--text-muted);text-align:right;opacity:.8}

    /* Rating modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.7);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{background:rgba(15,23,42,.96);border-radius:18px;padding:16px 16px 14px;max-width:320px;width:100%;
      box-shadow:0 20px 50px rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.5)}
    .modal-header{margin-bottom:8px}
    .modal-header h3{margin:0;font-size:1rem}
    .modal-header p{margin:4px 0 0;font-size:.8rem;color:var(--text-muted)}
    .rating-options{margin-top:10px;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:6px}
    .rating-option{border-radius:999px;border:1px solid rgba(129,140,248,.7);background:rgba(79,70,229,.2);padding:4px 6px;font-size:.78rem;color:#e5e7eb;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:4px}
    .rating-option span.emoji{font-size:1rem}
    .rating-option:hover{background:rgba(79,70,229,.35)}
    .modal-footer{margin-top:10px;display:flex;justify-content:flex-end}
    .modal-cancel{border-radius:999px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);color:var(--text-muted);font-size:.78rem;padding:4px 10px;cursor:pointer}
    .modal-cancel:hover{background:rgba(15,23,42,1)}

    /* Species overlay */
    .species-overlay{position:fixed;inset:0;background:rgba(15,23,42,.92);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .species-overlay.show{display:flex}
    .species-panel{max-width:520px;width:100%;max-height:90vh;background:rgba(15,23,42,.98);border-radius:20px;border:1px solid rgba(148,163,184,.5);
      box-shadow:0 24px 60px rgba(15,23,42,.95);padding:16px 16px 14px;display:flex;flex-direction:column}
    .species-panel-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .species-panel-header h3{margin:0;font-size:1rem}
    .species-panel-header p{margin:4px 0 0;font-size:.8rem;color:var(--text-muted)}
    .species-close-btn{border-radius:999px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);color:var(--text-muted);font-size:.78rem;padding:4px 10px;cursor:pointer;white-space:nowrap}
    .species-close-btn:hover{background:rgba(15,23,42,1)}
    .species-search-row{margin-top:10px}
    .species-search-row input{
      width:100%;border-radius:999px;border:1px solid var(--border-subtle);background:rgba(15,23,42,.9);padding:8px 12px;
      font-size:.9rem;color:var(--text-main);outline:none;
    }
    .species-search-row input:focus{border-color:#a5b4fc;box-shadow:0 0 0 1px rgba(129,140,248,.55);background:rgba(15,23,42,.98)}
    .species-list{margin-top:10px;overflow-y:auto;padding-right:4px}
    .species-empty{font-size:.82rem;color:var(--text-muted);padding:8px 2px}
    .species-item{
      width:100%;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:.86rem;
      padding:6px 10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer;
    }
    .species-item:hover{background:rgba(15,23,42,1)}
    .species-item.seen{border-color:rgba(129,140,248,.8);background:rgba(79,70,229,.18)}
    .species-name{text-align:left}
    .species-status{font-size:.75rem;color:#a5b4fc;padding:2px 8px;border-radius:999px;border:1px solid rgba(129,140,248,.7);white-space:nowrap}
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <div class="title-row">
        <img src="Logo.png" alt="Hornithological Baes logo" class="logo">
        <div>
          <div class="title-pill"><span class="title-pill-dot"></span>Live birb photo log</div>
          <h1>Hornithological Baes</h1>
        </div>
      </div>
      <p>Drop your birb pics, tag where and what they are, and let the flock rate your shots out of 10.</p>
    </div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="card-header">
        <h2>Add a sighting</h2>
        <span class="badge-soft">Drag &amp; drop supported</span>
      </div>

      <div id="dropzone" class="dropzone">
        <div class="dropzone-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 3L7 9h3v4h4V9h3l-5-6z" stroke="#e5e7eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 19h14" stroke="#e5e7eb" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <strong>Drop a birb photo</strong>
        <p>or click to browse â€“ JPG, PNG, HEIC etc.</p>
        <div class="chip"><span class="chip-dot"></span>Tip: close-up, well-lit shots rate best</div>
        <input id="fileInput" class="hidden-input" type="file" accept="image/*" />
      </div>

      <div id="preview" class="preview" style="display:none;">
        <img id="previewImg" alt="Preview" />
        <div class="preview-text">
          <div><strong id="previewName"></strong></div>
          <div style="margin-top:2px;">Ready to upload</div>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label for="birdName">Birb species</label>
          <div class="species-input-row">
            <input id="birdName" type="text" placeholder="Choose from checklist" autocomplete="off" readonly />
            <button type="button" id="openChecklistBtn" class="checklist-btn">Checklist</button>
          </div>
        </div>
        <div class="field">
          <label for="location">Where spotted</label>
          <input id="location" type="text" placeholder="e.g. Adelaide Botanic Gardens, SA" autocomplete="off" />
        </div>
        <div class="field">
          <label for="uploadedBy">Uploaded by</label>
          <input id="uploadedBy" type="text" placeholder="Your name or nickname" autocomplete="off" />
        </div>
      </div>

      <div class="actions-row">
        <div class="text-muted" id="statusText">All uploads are public. Please keep it friendly.</div>
        <button id="uploadBtn" class="btn-primary"><span>â†‘</span>Save sighting</button>
      </div>

      <div id="errorMsg" class="error-message" style="display:none;"></div>
      <div id="successMsg" class="success-message" style="display:none;"></div>
    </section>

    <section class="card">
      <div class="gallery-header">
        <div>
          <h2>Latest birbs</h2>
          <small id="galleryCountLabel">Loading sightingsâ€¦</small>
        </div>
        <div class="filter-badges">
          <span class="filter-badge">Newest first</span>
          <span class="filter-badge">Ratings use ðŸ¦œ out of 10</span>
        </div>
      </div>

      <div id="galleryEmpty" class="gallery-empty" style="display:none;">
        No birb photos yet. Upload the very first sighting and start the flock.
      </div>

      <div id="galleryGrid" class="gallery-grid"></div>
    </section>
  </div>

  <footer>Hornithological Baes Â· Firebase Â· GitHub Pages</footer>
</div>

<!-- Species checklist overlay -->
<div id="speciesOverlay" class="species-overlay">
  <div class="species-panel">
    <div class="species-panel-header">
      <div>
        <h3>Select birb species</h3>
        <p>Search and tap a species to fill the form. Species you've already logged are marked as seen.</p>
      </div>
      <button type="button" id="closeSpeciesOverlayBtn" class="species-close-btn">Close</button>
    </div>
    <div class="species-search-row">
      <input id="speciesSearch" type="text" placeholder="Search Australian birb speciesâ€¦" />
    </div>
    <div id="speciesList" class="species-list"></div>
  </div>
</div>

<!-- Rating modal -->
<div id="ratingModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Rate this birb</h3>
      <p>Pick a score out of 10.</p>
    </div>
    <div class="rating-options">
      <button class="rating-option" data-value="1"><span class="emoji">ðŸ¦œ</span><span>1</span></button>
      <button class="rating-option" data-value="2"><span class="emoji">ðŸ¦œ</span><span>2</span></button>
      <button class="rating-option" data-value="3"><span class="emoji">ðŸ¦œ</span><span>3</span></button>
      <button class="rating-option" data-value="4"><span class="emoji">ðŸ¦œ</span><span>4</span></button>
      <button class="rating-option" data-value="5"><span class="emoji">ðŸ¦œ</span><span>5</span></button>
      <button class="rating-option" data-value="6"><span class="emoji">ðŸ¦œ</span><span>6</span></button>
      <button class="rating-option" data-value="7"><span class="emoji">ðŸ¦œ</span><span>7</span></button>
      <button class="rating-option" data-value="8"><span class="emoji">ðŸ¦œ</span><span>8</span></button>
      <button class="rating-option" data-value="9"><span class="emoji">ðŸ¦œ</span><span>9</span></button>
      <button class="rating-option" data-value="10"><span class="emoji">ðŸ¦œ</span><span>10</span></button>
    </div>
    <div class="modal-footer">
      <button id="ratingModalCancel" class="modal-cancel">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyDkmpTvNw1IOCxS1NFr9_fqkZY73N0f1P8",
    authDomain: "hornithological-baes.firebaseapp.com",
    projectId: "hornithological-baes",
    storageBucket: "hornithological-baes.firebasestorage.app",
    messagingSenderId: "909306883752",
    appId: "1:909306883752:web:daf920bede5aa6fadf1c9d",
    measurementId: "G-T9VSSKQS0Q"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, orderBy, query, doc, getDoc,
    updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import {
    getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // ---- species list is loaded from ./species-au.json that you provide ----
  let SPECIES = [];

  // --- Normalize names so curly quotes / dashes won't break matching ---
  const normalizeName = (s) => (s || "")
    .trim()
    .toLowerCase()
    .replace(/[â€™â€˜]/g, "'")
    .replace(/[â€“â€”]/g, "-")
    .replace(/\s+/g, " ");

  // --- SUPER RARE + RARE ---
  const SUPER_RARE_SPECIES = new Set([
    "Citrine Wagtail","Fairy Pitta","Forest Wagtail","Japanese Sparrowhawk","Northern Pintail",
    "Oriental Honey-buzzard","Pechora Pipit","Red-backed Buttonquail"
  ].map(normalizeName));

  const RARE_SPECIES = new Set([
    "Asian Dowitcher","Broad-billed Sandpiper","Common Cuckoo","Eurasian Wigeon","Far Eastern Curlew","Garganey",
    "Great Knot","Little Ringed Plover","Oriental Cuckoo","Oriental Plover","Oriental Pratincole","Pectoral Sandpiper",
    "Pin-tailed Snipe","Swinhoe's Snipe","Tree Pipit","Turquoise Parrot","Wandering Tattler","Yellow Wagtail"
  ].map(normalizeName));

  // --- UNCOMMON / COMMON / VERY COMMON ---
  // Precedence of badge display: super rare > rare > uncommon > common > very common
  const UNCOMMON_SPECIES = new Set([
    "Australian Spotted Crake","Azure Kingfisher","Banded Lapwing","Banded Stilt","Bar-tailed Godwit",
    "Black Falcon","Black-breasted Buzzard","Black-eared Cuckoo","Black-faced Monarch","Black-tailed Nativehen",
    "Blue-winged Parrot","Blue-winged Pitta","Brown Skua","Caspian Tern","Channel-billed Cuckoo","Chestnut Rail",
    "Chestnut-backed Buttonquail","Chestnut-breasted Cuckoo","Chestnut-rumped Heathwren","Clamorous Reed Warbler",
    "Cockatiel","Comb-crested Jacana","Common Sandpiper","Common Noddy","Crimson Chat","Curlew Sandpiper",
    "Diamond Firetail","Double-eyed Fig-Parrot","Dusky Moorhen","Eastern Bristlebird","Eastern Grass Owl",
    "Eastern Yellow Wagtail","Eclectus Parrot","Elegant Parrot","Freckled Duck","Fuscous Honeyeater",
    "Gilbert's Honeyeater","Glossy Ibis","Golden-headed Cisticola","Great-billed Heron","Green Pygmy-Goose",
    "Grey Goshawk","Grey Nightjar","Grey Shrikethrush","Hoary-headed Grebe","Hooded Plover","Inland Dotterel",
    "King Quail","Large-tailed Nightjar","Latham's Snipe","Lewin's Rail","Little Curlew","Little Eagle",
    "Little Wattlebird","Long-tailed Finch","Lovely Fairywren","Macleay's Honeyeater","Mangrove Honeyeater",
    "Masked Booby","Mistletoebird","Mulga Parrot","Musk Duck","Nankeen Night-Heron","New Holland Honeyeater",
    "Noisy Scrub-bird","Orange Chat","Orange-footed Megapode","Pacific Swift","Painted Buttonquail",
    "Pale-headed Rosella","Pallid Cuckoo","Parasitic Jaeger","Pied Heron","Princess Parrot",
    "Purple-backed Fairywren","Purple-crowned Fairywren","Red Goshawk","Red-kneed Dotterel","Red-necked Crake",
    "Red-necked Phalarope","Red-necked Pharalope","Regent Bowerbird","Regent Honeyeater","Rock Parrot",
    "Rufous Scrub-bird","Satin Bowerbird","Southern Cassowary","Southern Emuwren","Spotted Harrier",
    "Spotted Nightjar","Star Finch","Stubble Quail","Swift Parrot","Tawny Grassbird","Tawny-crowned Honeyeater",
    "Thick-billed Grasswren","Varied Lorikeet","Wandering Whistling-Duck","Western Rosella","Wonga Pigeon",
    "Yellow Chat","Yellow-rumped Munia","Yellow-tailed Black-Cockatoo"
  ].map(normalizeName));

  const COMMON_SPECIES = new Set([
    "Australian Bustard","Australian Hobby","Australian Kestrel","Australian Pelican","Australian Reed-Warbler",
    "Australian Shelduck","Australian Wood Duck","Australian Magpie","Australian Raven","Australian Ringneck",
    "Bar-shouldered Dove","Black Kite","Black Swan","Black-winged Stilt","Blue-faced Honeyeater","Brahminy Kite",
    "Brown Falcon","Brown Goshawk","Brown Quail","Budgerigar","Cattle Egret","Cockatiel","Common Bronzewing",
    "Common Myna","Common Starling","Crested Pigeon","Crimson Rosella","Diamond Dove","Dusky Honeyeater",
    "Eastern Curlew","Eastern Osprey","Eastern Rosella","Eastern Spinebill","Fairy Martin","Galah",
    "Gang-gang Cockatoo","Golden Whistler","Grey Butcherbird","Grey Currawong","Grey Fantail","Grey Teal",
    "Hardhead","House Sparrow","Laughing Kookaburra","Little Black Cormorant","Little Bronze-Cuckoo","Little Corella",
    "Little Egret","Little Friarbird","Little Grebe","Little Lorikeet","Little Pied Cormorant","Little Penguin",
    "Magpie Goose","Maned Duck","Masked Lapwing","Mistletoebird","Musk Lorikeet","New Holland Honeyeater",
    "Noisy Friarbird","Noisy Miner","Noisy Pitta","Osprey","Pacific Black Duck","Peaceful Dove","Pied Cormorant",
    "Pied Oystercatcher","Pheasant Coucal","Pink-eared Duck","Rainbow Lorikeet","Red-browed Firetail",
    "Red-capped Plover","Red-rumped Parrot","Red-tailed Black-Cockatoo","Rock Dove","Royal Spoonbill","Silver Gull",
    "Singing Honeyeater","Spiny-cheeked Honeyeater","Splendid Fairywren","Superb Fairywren","Sulphur-crested Cockatoo",
    "Tawny Frogmouth","Torresian Imperial-Pigeon","Variegated Fairywren","Wedge-tailed Eagle","White-faced Heron",
    "White-plumed Honeyeater","White-throated Needletail","White-winged Fairywren","Willie Wagtail",
    "Yellow Wattlebird","Yellow-faced Honeyeater","Yellow-throated Miner"
  ].map(normalizeName));

  const VERY_COMMON_SPECIES = new Set([
    "Australian Ibis","Australian White Ibis","Australasian Darter","Australasian Grebe","Black-faced Cuckoo-shrike",
    "Black-fronted Dotterel","Black-shouldered Kite","Crested Pigeon","Eastern Great Egret","Great Cormorant",
    "Great Egret","Laughing Kookaburra","Little Raven","Magpie-lark","Masked Lapwing","Pacific Gull","Pied Stilt",
    "Purple Swamphen","Red Wattlebird","Silvereye","Straw-necked Ibis","Welcome Swallow","Whistling Kite",
    "White-bellied Sea-Eagle","White-browed Scrubwren","Wood Sandpiper","Zebra Finch"
  ].map(normalizeName));

  function getStatusBadge(birdNameRaw) {
    const n = normalizeName(birdNameRaw);

    if (SUPER_RARE_SPECIES.has(n)) return { cls: "status-super-rare", icon: "ðŸ’Ž", text: "Super rare find" };
    if (RARE_SPECIES.has(n))       return { cls: "status-rare",       icon: "â­", text: "Rare birb" };

    if (UNCOMMON_SPECIES.has(n))   return { cls: "status-uncommon",   icon: "ðŸª¶", text: "Uncommon" };
    if (COMMON_SPECIES.has(n))     return { cls: "status-common",     icon: "ðŸŒ¿", text: "Common" };
    if (VERY_COMMON_SPECIES.has(n))return { cls: "status-very-common",icon: "ðŸ¡", text: "Very common" };

    return null;
  }

  const photosCol = collection(db, "birdPhotos");

  // DOM
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("preview");
  const previewImg = document.getElementById("previewImg");
  const previewName = document.getElementById("previewName");
  const birdNameInput = document.getElementById("birdName");
  const locationInput = document.getElementById("location");
  const uploadedByInput = document.getElementById("uploadedBy");
  const uploadBtn = document.getElementById("uploadBtn");
  const statusText = document.getElementById("statusText");
  const errorMsg = document.getElementById("errorMsg");
  const successMsg = document.getElementById("successMsg");
  const galleryGrid = document.getElementById("galleryGrid");
  const galleryEmpty = document.getElementById("galleryEmpty");
  const galleryCountLabel = document.getElementById("galleryCountLabel");

  const ratingModalBackdrop = document.getElementById("ratingModalBackdrop");
  const ratingModalCancel = document.getElementById("ratingModalCancel");
  const ratingOptionButtons = ratingModalBackdrop.querySelectorAll(".rating-option");

  const speciesOverlay = document.getElementById("speciesOverlay");
  const speciesListEl = document.getElementById("speciesList");
  const speciesSearch = document.getElementById("speciesSearch");
  const openChecklistBtn = document.getElementById("openChecklistBtn");
  const closeSpeciesOverlayBtn = document.getElementById("closeSpeciesOverlayBtn");

  let selectedFile = null;
  let ratingTargetPhotoId = null;
  let currentSeenSpecies = new Set();
  let speciesLoaded = false;
  let speciesLoadError = false;

  async function loadSpeciesJson() {
    try {
      const res = await fetch("species-au.json", { cache: "no-cache" });
      if (!res.ok) throw new Error("Failed to fetch species JSON");
      const data = await res.json();
      if (Array.isArray(data)) SPECIES = data;
      else if (Array.isArray(data.species)) SPECIES = data.species;
      else SPECIES = [];
      speciesLoaded = true;
      speciesLoadError = false;
      renderSpeciesList(speciesSearch.value);
    } catch (err) {
      console.error("Error loading species-au.json", err);
      speciesLoaded = true;
      speciesLoadError = true;
      renderSpeciesList(speciesSearch.value);
    }
  }
  loadSpeciesJson();

  // Drag/drop
  function handleFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];
    if (!file.type.startsWith("image/")) return showError("Please upload an image file.");
    selectedFile = file;
    previewImg.src = URL.createObjectURL(file);
    previewName.textContent = file.name;
    preview.style.display = "flex";
    hideError(); hideSuccess();
  }

  dropzone.addEventListener("click", () => fileInput.click());
  dropzone.addEventListener("dragover", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add("dragover"); });
  dropzone.addEventListener("dragleave", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("dragover"); });
  dropzone.addEventListener("drop", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });
  fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

  // Upload
  uploadBtn.addEventListener("click", async () => {
    hideError(); hideSuccess();
    const birdName = birdNameInput.value.trim();
    const location = locationInput.value.trim();
    const uploadedBy = uploadedByInput.value.trim();

    if (!selectedFile) return showError("Select or drop a birb photo first.");
    if (!birdName) { showError("Choose a birb species from the checklist."); birdNameInput.focus(); return; }
    if (!location) { showError("Enter where the photo was taken."); locationInput.focus(); return; }

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploadingâ€¦";
    statusText.textContent = "Uploading image and saving to the databaseâ€¦";

    try {
      const fileId = `${Date.now()}_${selectedFile.name}`;
      const storagePath = `birdPhotos/${fileId}`;
      const imgRef = storageRef(storage, storagePath);
      await uploadBytes(imgRef, selectedFile);
      const url = await getDownloadURL(imgRef);

      await addDoc(photosCol, {
        birdName,
        location,
        uploadedBy: uploadedBy || null,
        imageUrl: url,
        storagePath,
        createdAt: serverTimestamp(),
        ratingTotal: 0,
        ratingCount: 0
      });

      showSuccess("Sighting saved. Check the gallery on the right.");
      resetForm();
    } catch (err) {
      console.error(err);
      showError("Upload failed. Check Firebase config, rules, or bucket name.");
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = "Save sighting";
      statusText.textContent = "All uploads are public. Please keep it friendly.";
    }
  });

  function resetForm() {
    selectedFile = null;
    fileInput.value = "";
    birdNameInput.value = "";
    locationInput.value = "";
    uploadedByInput.value = "";
    preview.style.display = "none";
  }

  function showError(msg){ errorMsg.textContent = msg; errorMsg.style.display = "block"; }
  function hideError(){ errorMsg.textContent = ""; errorMsg.style.display = "none"; }
  function showSuccess(msg){ successMsg.textContent = msg; successMsg.style.display = "block"; setTimeout(()=>successMsg.style.display="none",3500); }
  function hideSuccess(){ successMsg.textContent = ""; successMsg.style.display = "none"; }

  // Ratings stored locally per browser
  const ratingsKey = "hornithological_baes_ratings_v1";
  let localRatings = {};
  try { const stored = localStorage.getItem(ratingsKey); if (stored) localRatings = JSON.parse(stored); } catch { localRatings = {}; }
  function saveLocalRatings(){ try { localStorage.setItem(ratingsKey, JSON.stringify(localRatings)); } catch {} }

  // Live gallery
  const qPhotos = query(photosCol, orderBy("createdAt", "desc"));

  onSnapshot(qPhotos, (snapshot) => {
    galleryGrid.innerHTML = "";
    currentSeenSpecies = new Set();

    const docs = [];
    snapshot.forEach(docSnap => docs.push({ id: docSnap.id, data: docSnap.data() }));

    if (!docs.length) {
      galleryEmpty.style.display = "block";
      galleryCountLabel.textContent = "No sightings yet.";
      return;
    }

    const speciesCounts = {};
    docs.forEach(({ data }) => {
      const name = (data.birdName || "Unknown birb").trim();
      if (!name) return;
      speciesCounts[name] = (speciesCounts[name] || 0) + 1;
    });
    currentSeenSpecies = new Set(Object.keys(speciesCounts));

    galleryEmpty.style.display = "none";
    galleryCountLabel.textContent = `${docs.length} sighting${docs.length > 1 ? "s" : ""}`;

    docs.forEach(({ id, data }) => {
      const imgUrl = data.imageUrl || "";
      const birdName = data.birdName || "Unknown birb";
      const location = data.location || "Unknown location";
      const uploadedBy = data.uploadedBy || "Anonymous";
      const ratingTotal = data.ratingTotal || 0;
      const ratingCount = data.ratingCount || 0;
      const averageRating = ratingCount > 0 ? ratingTotal / ratingCount : 0;
      const rounded = ratingCount > 0 ? Math.round(averageRating * 10) / 10 : 0;
      const filledParrots = Math.round(averageRating || 0);

      const isRepeat = (speciesCounts[birdName] || 0) > 1;
      const repeatTagHtml = isRepeat ? `<div class="repeat-species-tag">Repeat species</div>` : "";

      const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      const timeAgo = createdAt ? formatTimeAgo(createdAt) : "Just now";

      const parrotsHtml = Array.from({ length: 10 }, (_, idx) => {
        const i = idx + 1;
        return `<span class="parrot ${i <= filledParrots ? "filled" : ""}">ðŸ¦œ</span>`;
      }).join("");

      const badge = getStatusBadge(birdName);
      const badgeHtml = badge
        ? `<div class="status-badge ${badge.cls}"><span class="icon">${badge.icon}</span><span>${badge.text}</span></div>`
        : "";

      const card = document.createElement("article");
      card.className = "photo-card";
      card.dataset.photoId = id;

      card.innerHTML = `
        <div class="photo-thumb">
          <img src="${imgUrl}" alt="${escapeHtml(birdName)}" loading="lazy" />
          <div class="photo-chip"><span class="dot"></span><span>${escapeHtml(birdName)}</span></div>
          ${badgeHtml}
        </div>
        <div class="photo-body">
          <div class="photo-title">${escapeHtml(birdName)}</div>
          <div class="photo-uploaded-by">Uploaded by ${escapeHtml(uploadedBy)}</div>
          <div class="photo-location-row">
            <div class="photo-location">${escapeHtml(location)}</div>
            ${repeatTagHtml}
          </div>
          <div class="photo-meta-row">
            <div class="rating-wrapper">
              <div class="parrots">${parrotsHtml}</div>
              <div class="rating-text">
                ${ratingCount === 0 ? "Not rated yet â€“ be first." : `${rounded.toFixed(1)} / 10 Â· ${ratingCount} rating${ratingCount > 1 ? "s" : ""}`}
              </div>
            </div>
            <span class="time-tag">${timeAgo}</span>
          </div>
          <div class="card-footer-row">
            <button class="rate-btn" data-photo-id="${id}">Tap here to rate /10</button>
            <button class="delete-btn" data-photo-id="${id}">ðŸ—‘ Delete</button>
          </div>
        </div>
      `;
      galleryGrid.appendChild(card);
    });

    if (speciesOverlay.classList.contains("show")) renderSpeciesList(speciesSearch.value);
  });

  // Rating modal
  function openRatingModal(photoId){ ratingTargetPhotoId = photoId; ratingModalBackdrop.classList.add("show"); }
  function closeRatingModal(){ ratingTargetPhotoId = null; ratingModalBackdrop.classList.remove("show"); }
  ratingModalCancel.addEventListener("click", closeRatingModal);
  ratingModalBackdrop.addEventListener("click", (e) => { if (e.target === ratingModalBackdrop) closeRatingModal(); });

  ratingOptionButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!ratingTargetPhotoId) return;
      const value = parseInt(btn.dataset.value, 10);
      if (!value) return;
      try { await ratePhoto(ratingTargetPhotoId, value); }
      catch (err) { console.error(err); showError("Could not save rating. Check Firebase rules."); }
      finally { closeRatingModal(); }
    });
  });

  // Gallery buttons
  galleryGrid.addEventListener("click", async (e) => {
    const deleteBtn = e.target.closest(".delete-btn");
    if (deleteBtn) {
      const photoId = deleteBtn.dataset.photoId;
      if (!photoId) return;
      if (!window.confirm("Delete this sighting? This cannot be undone.")) return;
      try { await deletePhoto(photoId); }
      catch (err) { console.error(err); showError("Could not delete sighting. Check Firebase rules."); }
      return;
    }

    const rateBtn = e.target.closest(".rate-btn");
    if (rateBtn) {
      const photoId = rateBtn.dataset.photoId;
      if (!photoId) return;
      openRatingModal(photoId);
    }
  });

  async function ratePhoto(photoId, ratingValue) {
    const docRef = doc(db, "birdPhotos", photoId);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;

    const data = snap.data();
    let ratingTotal = data.ratingTotal || 0;
    let ratingCount = data.ratingCount || 0;

    const prevRating = localRatings[photoId];
    if (!prevRating) { ratingTotal += ratingValue; ratingCount += 1; }
    else { ratingTotal = ratingTotal - prevRating + ratingValue; }

    await updateDoc(docRef, { ratingTotal, ratingCount });

    localRatings[photoId] = ratingValue;
    saveLocalRatings();
  }

  async function deletePhoto(photoId) {
    const docRef = doc(db, "birdPhotos", photoId);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;

    const data = snap.data();
    const storagePath = data.storagePath;

    if (storagePath) {
      try { await deleteObject(storageRef(storage, storagePath)); }
      catch (e) { console.error("Error deleting file from storage:", e); }
    }

    delete localRatings[photoId];
    saveLocalRatings();
    await deleteDoc(docRef);
  }

  // Species overlay
  function openSpeciesOverlay(){
    speciesOverlay.classList.add("show");
    speciesSearch.value = "";
    renderSpeciesList("");
    setTimeout(()=>speciesSearch.focus(), 50);
  }
  function closeSpeciesOverlay(){ speciesOverlay.classList.remove("show"); }

  openChecklistBtn.addEventListener("click", openSpeciesOverlay);
  birdNameInput.addEventListener("click", openSpeciesOverlay);
  closeSpeciesOverlayBtn.addEventListener("click", closeSpeciesOverlay);
  speciesOverlay.addEventListener("click", (e) => { if (e.target === speciesOverlay) closeSpeciesOverlay(); });
  speciesSearch.addEventListener("input", (e) => renderSpeciesList(e.target.value));

  function renderSpeciesList(filter) {
    const term = (filter || "").toLowerCase().trim();
    speciesListEl.innerHTML = "";

    if (!speciesLoaded && !speciesLoadError) {
      const loading = document.createElement("div");
      loading.className = "species-empty";
      loading.textContent = "Loading species listâ€¦";
      speciesListEl.appendChild(loading);
      return;
    }

    if (speciesLoadError) {
      const err = document.createElement("div");
      err.className = "species-empty";
      err.textContent = "Could not load species-au.json. Check the file exists in the same folder.";
      speciesListEl.appendChild(err);
      return;
    }

    const filtered = SPECIES.filter(name => (name || "").toLowerCase().includes(term));
    if (!filtered.length) {
      const empty = document.createElement("div");
      empty.className = "species-empty";
      empty.textContent = "No matches. Try a different spelling.";
      speciesListEl.appendChild(empty);
      return;
    }

    filtered.forEach(name => {
      const isSeen = currentSeenSpecies.has(name);
      const badge = getStatusBadge(name);
      const statusText = badge ? badge.text : "";
      const statusIcon = badge ? badge.icon : "";
      const statusMini = badge ? `<span class="species-status">${statusIcon} ${statusText}</span>` : (isSeen ? '<span class="species-status">Seen</span>' : "");

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "species-item" + (isSeen ? " seen" : "");
      btn.dataset.name = name;
      btn.innerHTML = `<span class="species-name">${escapeHtml(name)}</span>${statusMini}`;
      speciesListEl.appendChild(btn);
    });
  }

  speciesListEl.addEventListener("click", (e) => {
    const item = e.target.closest(".species-item");
    if (!item) return;
    birdNameInput.value = item.dataset.name || "";
    closeSpeciesOverlay();
  });

  // Helpers
  function escapeHtml(str) {
    if (typeof str !== "string") return "";
    return str.replace(/[&<>"']/g, (c) => (
      c === "&" ? "&amp;" :
      c === "<" ? "&lt;" :
      c === ">" ? "&gt;" :
      c === '"' ? "&quot;" : "&#039;"
    ));
  }

  function formatTimeAgo(date) {
    const now = new Date();
    const diff = (now.getTime() - date.getTime()) / 1000;
    if (diff < 60) return "Just now";
    const mins = Math.floor(diff / 60);
    if (mins < 60) return `${mins} min${mins === 1 ? "" : "s"} ago`;
    const hours = Math.floor(mins / 60);
    if (hours < 24) return `${hours} hr${hours === 1 ? "" : "s"} ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} day${days === 1 ? "" : "s"} ago`;
    return date.toLocaleDateString();
  }
</script>
</body>
</html>
