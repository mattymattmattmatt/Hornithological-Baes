<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hornithological Baes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050816;--bg-elevated:#0d1022;--accent:#4f46e5;--accent-soft:rgba(79,70,229,.15);
      --accent-strong:rgba(129,140,248,.35);--text-main:#f9fafb;--text-muted:#9ca3af;
      --border-subtle:rgba(148,163,184,.25);--danger:#ef4444;--radius-lg:18px;--radius-md:12px;
      --shadow-soft:0 18px 45px rgba(15,23,42,.65);
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:radial-gradient(circle at top left,#1d2446 0,transparent 55%),
                 radial-gradient(circle at bottom right,#164e63 0,transparent 55%),
                 var(--bg);
      color:var(--text-main);min-height:100vh;
    }
    .app-shell{max-width:1120px;margin:0 auto;padding:28px 16px 40px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px}
    .title-block{display:flex;flex-direction:column;gap:8px}
    .title-row{display:flex;align-items:center;gap:12px}
    .logo{
      height:122px;
      width:auto;border-radius:12px;object-fit:contain;background:rgba(15,23,42,.7);
      padding:4px 8px;border:1px solid rgba(148,163,184,.4);
    }
    .title-pill{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.17em;
      color:#e5e7eb;
      background:rgba(255,255,255,.08);
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(255,255,255,.18);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .title-pill-dot{
      width:8px;height:8px;border-radius:999px;
      background:#34d399;
      box-shadow:0 0 0 4px rgba(52,211,153,.35);
    }
    .title-block h1{margin:0;font-size:1.9rem;letter-spacing:.03em}
    .title-block p{margin:0;font-size:.9rem;color:var(--text-muted)}
    .layout{display:grid;grid-template-columns:minmax(0,340px) minmax(0,1fr);gap:20px}
    @media (max-width:900px){
      header{flex-direction:column;align-items:flex-start}
      .layout{grid-template-columns:minmax(0,1fr)}
    }
    .card{
      background:radial-gradient(circle at top,rgba(148,163,184,.12) 0,transparent 55%),var(--bg-elevated);
      border-radius:var(--radius-lg);padding:18px 18px 16px;box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,.18);backdrop-filter:blur(18px);
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:10px}
    .card-header h2{margin:0;font-size:1rem;letter-spacing:.08em;text-transform:uppercase;color:#e5e7eb}

    .dropzone{
      border-radius:var(--radius-md);border:1px dashed rgba(148,163,184,.55);padding:18px;
      background:radial-gradient(circle at top left,rgba(79,70,229,.16) 0,transparent 55%),rgba(15,23,42,.85);
      display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;
      transition:border .15s ease,background .15s ease,transform .08s ease;cursor:pointer;
    }
    .dropzone.dragover{
      border-color:#a5b4fc;background:radial-gradient(circle at top left,rgba(79,70,229,.45) 0,transparent 65%),rgba(15,23,42,.96);
      transform:translateY(-1px);
    }
    .dropzone-icon{
      width:40px;height:40px;border-radius:16px;background:linear-gradient(145deg,rgba(129,140,248,.3),rgba(56,189,248,.25));
      display:flex;align-items:center;justify-content:center;margin-bottom:8px;box-shadow:0 14px 35px rgba(37,99,235,.5);
    }
    .dropzone-icon svg{width:21px;height:21px}
    .dropzone strong{font-size:.92rem}
    .dropzone p{margin:3px 0 0;font-size:.8rem;color:var(--text-muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;margin-top:10px;padding:3px 8px;border-radius:999px;background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.4);font-size:.78rem;color:var(--text-muted)}
    .chip-dot{width:6px;height:6px;border-radius:999px;background:#38bdf8}
    .hidden-input{display:none}
    .preview{margin-top:10px;display:flex;gap:10px;align-items:center}
    .preview img{width:70px;height:70px;object-fit:cover;border-radius:14px;border:1px solid rgba(148,163,184,.4)}
    .preview-text{font-size:.82rem;color:var(--text-muted)}
    .preview-text strong{color:#e5e7eb}
    .form-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:.8rem;text-transform:uppercase;letter-spacing:.15em;color:var(--text-muted)}
    .field input{
      border-radius:999px;border:1px solid var(--border-subtle);background:rgba(15,23,42,.9);padding:8px 12px;
      font-size:.9rem;color:var(--text-main);outline:none;transition:border .15s ease,box-shadow .15s ease,background .15s ease;
    }
    .field input:focus{border-color:#a5b4fc;box-shadow:0 0 0 1px rgba(129,140,248,.55);background:rgba(15,23,42,.98)}
    .species-input-row{display:flex;gap:8px;align-items:center}
    .species-input-row input{flex:1;cursor:pointer}
    .checklist-btn{
      border-radius:999px;border:1px solid rgba(129,140,248,.7);background:rgba(79,70,229,.16);color:#c7d2fe;
      font-size:.78rem;padding:6px 10px;cursor:pointer;white-space:nowrap;
    }
    .checklist-btn:hover{background:rgba(79,70,229,.26)}
    .actions-row{margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .text-muted{font-size:.78rem;color:var(--text-muted)}
    .btn-primary{
      appearance:none;border:none;border-radius:999px;padding:8px 16px;font-size:.9rem;font-weight:600;
      background:linear-gradient(135deg,#4f46e5,#06b6d4);color:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:0 12px 28px rgba(37,99,235,.55);transition:transform .08s ease,box-shadow .08s ease,filter .12s ease;
    }
    .btn-primary span{font-size:1rem}
    .btn-primary:disabled{opacity:.6;cursor:default;box-shadow:none;transform:none}
    .btn-primary:not(:disabled):hover{transform:translateY(-1px);filter:brightness(1.06);box-shadow:0 16px 36px rgba(37,99,235,.75)}
    .error-message{margin-top:6px;font-size:.78rem;color:#fecaca}
    .success-message{margin-top:6px;font-size:.78rem;color:#bbf7d0}

    .gallery-header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;
      position:relative;
    }
    .gallery-header h2{margin:0;font-size:1rem;text-transform:uppercase;letter-spacing:.11em}
    .gallery-header small{font-size:.8rem;color:var(--text-muted)}
    .filter-badges{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .filter-badge{
      font-size:.76rem;padding:3px 9px;border-radius:999px;border:1px solid rgba(148,163,184,.4);
      color:var(--text-muted);background:rgba(15,23,42,.9);
    }
    .filter-badge.sort-btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      color:#e5e7eb;
      border-color:rgba(129,140,248,.55);
      background:rgba(79,70,229,.16);
    }
    .filter-badge.sort-btn:hover{
      background:rgba(79,70,229,.26);
    }
    .sort-menu{
      position:absolute;
      right:0;
      top:100%;
      margin-top:6px;
      background:rgba(15,23,42,.98);
      border-radius:14px;
      border:1px solid rgba(148,163,184,.45);
      box-shadow:0 18px 45px rgba(15,23,42,.9);
      padding:6px;
      z-index:15;
      min-width:220px;
      display:none;
    }
    .sort-menu.show{display:block;}
    .sort-option{
      width:100%;
      appearance:none;
      border:none;
      background:transparent;
      color:#e5e7eb;
      text-align:left;
      padding:6px 8px;
      border-radius:10px;
      font-size:.82rem;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    .sort-option span.hint{color:var(--text-muted);font-size:.76rem;}
    .sort-option:hover{
      background:rgba(79,70,229,.2);
    }

    /* New birbs banner */
    .new-birbs-banner{
      display:none;
      margin-bottom:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(74,222,128,.6);
      background:rgba(34,197,94,.16);
      font-size:.8rem;
      color:#bbf7d0;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor:pointer;
    }
    .new-birbs-banner span.secondary{
      font-size:.78rem;
      color:#dcfce7;
      white-space:nowrap;
    }

    /* Pager */
    .pager{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:10px 0 12px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.35);
    }
    .pager-label{
      font-size:.8rem;
      color:var(--text-muted);
      white-space:nowrap;
    }
    .pager-btn{
      border:none;
      border-radius:999px;
      padding:6px 12px;
      font-size:.78rem;
      cursor:pointer;
      background:rgba(79,70,229,.18);
      color:#c7d2fe;
      border:1px solid rgba(129,140,248,.6);
    }
    .pager-btn:disabled{
      opacity:.45;
      cursor:default;
      background:rgba(15,23,42,.85);
      border-style:dashed;
      color:#9ca3af;
    }
    .pager-btn:hover:not(:disabled){ background:rgba(79,70,229,.28); }

    .gallery-empty{padding:16px 12px 12px;border-radius:var(--radius-md);background:rgba(15,23,42,.85);border:1px dashed rgba(148,163,184,.45);
      text-align:center;font-size:.86rem;color:var(--text-muted)}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:14px}
    .photo-card{
      background:radial-gradient(circle at top,rgba(79,70,229,.18) 0,transparent 55%),rgba(15,23,42,.96);
      border-radius:16px;border:1px solid rgba(148,163,184,.3);overflow:hidden;display:flex;flex-direction:column;min-height:230px;
    }
    .photo-thumb{position:relative;padding-top:66%;overflow:hidden}
    .photo-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform-origin:center;transition:transform .2s ease-out}
    .photo-card:hover .photo-thumb img{transform:scale(1.03)}

    .rarity-badge-wrap{
      position:absolute;left:8px;bottom:8px;width:42px;height:42px;border-radius:14px;
      background:rgba(15,23,42,.55);border:1px solid rgba(148,163,184,.55);
      display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);
      box-shadow:0 10px 25px rgba(15,23,42,.7);pointer-events:none;
    }
    .rarity-badge{width:32px;height:32px;object-fit:contain;display:block;}

    /* Fullscreen icon only */
    .fullscreen-btn {
      position: absolute;
      right: 6px;
      bottom: 6px;
      border: none;
      background: none;
      color: #e5e7eb;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      text-shadow: 0 1px 3px rgba(0,0,0,0.9);
    }
    .fullscreen-btn:hover {
      transform: scale(1.05);
    }
    .image-fullscreen-overlay {
      position: fixed;
      inset: 0;
      background: rgba(3,7,18,0.96);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 120;
    }
    .image-fullscreen-overlay.show {
      display: flex;
    }
    .image-fullscreen-overlay img {
      max-width: 100vw;
      max-height: 100vh;
      object-fit: contain;
    }
    .image-fullscreen-overlay::after {
      content: "Tap anywhere to close";
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: rgba(229,231,235,0.8);
    }

    .photo-body{padding:10px 11px 9px;display:flex;flex-direction:column;gap:5px;flex-grow:1}
    .photo-title{font-size:.95rem;font-weight:600;color:#e5e7eb}
    .photo-uploaded-by{font-size:.78rem;color:var(--text-muted)}
    .photo-location-row{display:flex;justify-content:space-between;gap:6px;align-items:center}
    .photo-location{font-size:.8rem;color:var(--text-muted)}
    .repeat-species-tag{font-size:.75rem;color:#a5b4fc;background:rgba(79,70,229,.16);border-radius:999px;padding:2px 8px;border:1px solid rgba(129,140,248,.5);white-space:nowrap}
    .photo-meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:2px;gap:6px}
    .rating-wrapper{display:flex;flex-direction:column;gap:3px}
    .parrots{display:inline-flex;gap:1px;flex-wrap:wrap;font-size:.9rem}
    .parrot{opacity:.2;transition:opacity .15s ease}
    .parrot.filled{opacity:1}
    .rating-text{font-size:.75rem;color:var(--text-muted)}
    .time-tag{font-size:.76rem;color:var(--text-muted);padding:4px 9px;border-radius:999px;background:rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.4)}
    .card-footer-row{display:flex;justify-content:space-between;margin-top:6px;gap:8px;align-items:center}
    .footer-actions-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .rate-btn,.comments-btn{
      border:none;border-radius:999px;padding:4px 10px;font-size:.75rem;cursor:pointer;
      background:rgba(79,70,229,.18);color:#c7d2fe;border:1px solid rgba(129,140,248,.6)
    }
    .rate-btn[disabled]{opacity:.55;cursor:default;background:rgba(15,23,42,.85);border-style:dashed;color:#9ca3af}
    .rate-btn:hover:not(:disabled),.comments-btn:hover{background:rgba(79,70,229,.28)}
    .delete-btn{border:none;border-radius:999px;padding:4px 10px;font-size:.75rem;cursor:pointer;background:rgba(239,68,68,.12);color:#fecaca;border:1px solid rgba(248,113,113,.5);display:inline-flex;align-items:center;gap:6px}
    .delete-btn:hover{background:rgba(239,68,68,.22)}
    footer{margin-top:18px;font-size:.78rem;color:var(--text-muted);text-align:right;opacity:.8}

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.7);display:none;align-items:center;justify-content:center;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{
      background:rgba(15,23,42,.96);border-radius:18px;padding:16px 16px 14px;max-width:380px;width:100%;
      box-shadow:0 20px 50px rgba(15,23,42,.9);border:1px solid rgba(148,163,184,.5)
    }
    .modal-header{margin-bottom:8px}
    .modal-header h3{margin:0;font-size:1rem}
    .modal-header p{margin:4px 0 0;font-size:.8rem;color:var(--text-muted)}
    .modal-footer{margin-top:10px;display:flex;justify-content:flex-end;gap:8px}
    .modal-cancel{
      border-radius:999px;border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);color:var(--text-muted);
      font-size:.78rem;padding:6px 12px;cursor:pointer
    }
    .modal-cancel:hover{background:rgba(15,23,42,1)}
    .modal-accent{
      border-radius:999px;border:1px solid rgba(129,140,248,.7);
      background:rgba(79,70,229,.16);color:#c7d2fe;
      font-size:.78rem;padding:6px 12px;cursor:pointer
    }
    .modal-accent:hover{background:rgba(79,70,229,.26)}
    .rating-options{margin-top:10px;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:6px}
    .rating-option{border-radius:999px;border:1px solid rgba(129,140,248,.7);background:rgba(79,70,229,.2);padding:4px 6px;font-size:.78rem;color:#e5e7eb;cursor:pointer;
      display:flex;align-items:center;justify-content:center;gap:4px}
    .rating-option span.emoji{font-size:1rem}
    .rating-option:hover{background:rgba(79,70,229,.35)}

    /* Comments */
    .comments-list{
      margin-top:10px;max-height:40vh;overflow:auto;padding-right:4px;
      display:flex;flex-direction:column;gap:8px;
    }
    .comment-empty{font-size:.82rem;color:var(--text-muted);padding:6px 2px}
    .comment-item{
      border:1px solid rgba(148,163,184,.35);
      background:rgba(15,23,42,.9);
      border-radius:14px;
      padding:8px 10px;
    }
    .comment-meta{
      display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:4px;
    }
    .comment-meta .time{font-size:.75rem;color:var(--text-muted)}
    .comment-del{
      width:26px;height:26px;border-radius:999px;
      border:1px solid rgba(248,113,113,.55);
      background:rgba(239,68,68,.10);
      color:#fecaca;
      font-size:18px;line-height:1;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      padding:0;
    }
    .comment-del:hover{background:rgba(239,68,68,.20)}
    .comment-text{
      font-size:.88rem;color:#e5e7eb;line-height:1.35;
      white-space:pre-wrap;word-break:break-word
    }
    .comment-compose{margin-top:10px;display:flex;flex-direction:column;gap:8px;}
    textarea.comment-input{
      width:100%;min-height:72px;resize:none;border-radius:14px;
      border:1px solid rgba(148,163,184,.35);background:rgba(15,23,42,.92);
      padding:10px 10px;color:#e5e7eb;font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:.9rem;outline:none;
    }
    textarea.comment-input:focus{
      border-color:#a5b4fc;box-shadow:0 0 0 1px rgba(129,140,248,.55);background:rgba(15,23,42,.98);
    }
    .comment-send{
      align-self:flex-end;appearance:none;border:none;border-radius:999px;padding:8px 14px;
      font-size:.85rem;font-weight:700;background:linear-gradient(135deg,#4f46e5,#06b6d4);
      color:#fff;cursor:pointer;box-shadow:0 12px 28px rgba(37,99,235,.45);
    }
    .comment-send:disabled{opacity:.6;cursor:default;box-shadow:none}
    .comment-send:hover:not(:disabled){filter:brightness(1.05);transform:translateY(-1px)}

    /* Species overlay */
    .species-overlay{position:fixed;inset:0;background:rgba(15,23,42,.92);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .species-overlay.show{display:flex}
    .species-panel{max-width:520px;width:100%;max-height:90vh;background:rgba(15,23,42,.98);border-radius:20px;border:1px solid rgba(148,163,184,.5);
      box-shadow:0 24px 60px rgba(15,23,42,.95);padding:16px 16px 14px;display:flex;flex-direction:column}
    .species-panel-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .species-panel-header h3{margin:0;font-size:1rem}
    .species-panel-header p{margin:4px 0 0;font-size:.8rem;color:var(--text-muted)}
    .species-close-btn{border-radius:999px;border:1px solid rgba(148,163,184,.6);background:rgba(15,23,42,.9);color:var(--text-muted);font-size:.78rem;padding:4px 10px;cursor:pointer;white-space:nowrap}
    .species-close-btn:hover{background:rgba(15,23,42,1)}
    .species-tally{
      margin-top:6px;
      font-size:.8rem;
      color:var(--text-muted);
    }
    .species-tally span.seen{
      color:#bbf7d0;
      font-weight:600;
    }
    .species-tally span.unseen{
      color:#e5e7ebb0;
    }
    .species-search-row{margin-top:10px}
    .species-search-row input{
      width:100%;border-radius:999px;border:1px solid var(--border-subtle);background:rgba(15,23,42,.9);padding:8px 12px;
      font-size:.9rem;color:var(--text-main);outline:none;
    }
    .species-search-row input:focus{border-color:#a5b4fc;box-shadow:0 0 0 1px rgba(129,140,248,.55);background:rgba(15,23,42,.98)}
    .species-list{margin-top:10px;overflow-y:auto;padding-right:4px}
    .species-empty{font-size:.82rem;color:var(--text-muted);padding:8px 2px}
    .species-item{
      width:100%;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:rgba(15,23,42,.9);color:#e5e7eb;font-size:.86rem;
      padding:6px 10px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;gap:8px;cursor:pointer;
    }
    .species-item:hover{background:rgba(15,23,42,1)}
    .species-item.seen{border-color:rgba(129,140,248,.8);background:rgba(79,70,229,.18)}
    .species-name{text-align:left}
    .species-status{font-size:.75rem;color:#a5b4fc;padding:2px 8px;border-radius:999px;border:1px solid rgba(129,140,248,.7);white-space:nowrap}

    /* Merlin */
    .merlin-help{
      appearance:none;width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin-top:10px;padding:10px 12px;border-radius:999px;border:1px solid rgba(148,163,184,0.45);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.18) 0, transparent 55%), rgba(15,23,42,0.9);
      color:#e5e7eb;font-size:0.86rem;cursor:pointer;text-align:left;
    }
    .merlin-help strong{ color:#bbf7d0; font-weight:700; }
    .merlin-help:hover{
      border-color: rgba(187,247,208,0.75);
      background: radial-gradient(circle at top left, rgba(34,197,94,0.28) 0, transparent 60%), rgba(15,23,42,1);
    }

    /* Rankings */
    .rankings-btn{
      font-size:.78rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(129,140,248,.7);
      background:rgba(79,70,229,.18);
      color:#c7d2fe;
      cursor:pointer;
      white-space:nowrap;
    }
    .rankings-btn:hover{background:rgba(79,70,229,.28)}
    .rankings-list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:55vh;overflow:auto;padding-right:3px}
    .rankings-row{
      display:grid;
      grid-template-columns:40px 1fr 80px 90px;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.9);
      font-size:.88rem;
    }
    .rankings-head{
      background:rgba(79,70,229,.14);
      border-color:rgba(129,140,248,.35);
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--text-muted);
    }
    .rankings-row .right{text-align:right}
    .rankings-empty{font-size:.82rem;color:var(--text-muted);padding:6px 2px}

    .rules-box{
      margin-top:10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(15,23,42,.9);
      padding:10px 12px;
      color:#e5e7eb;
      font-size:.86rem;
      line-height:1.35;
    }
    .rules-box code{
      display:inline-block;
      margin-top:6px;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(79,70,229,.14);
      border:1px solid rgba(129,140,248,.35);
      color:#e5e7eb;
      font-size:.82rem;
    }
    .rules-list{margin:8px 0 0;padding-left:18px;color:var(--text-muted)}
    .rules-list li{margin:4px 0}

    /* Mobile compositing fix */
    @media (max-width: 700px){
      .card{ backdrop-filter:none; }
      .rarity-badge-wrap{ backdrop-filter:none; }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header>
    <div class="title-block">
      <div class="title-row">
        <img src="Logo.png" alt="Hornithological Baes logo" class="logo">
        <div>
          <div class="title-pill"><span class="title-pill-dot"></span>Live birb photo log</div>
          <h1>Hornithological Baes</h1>
        </div>
      </div>
      <p>Drop your birb pics, tag where and what they are, and let the flock rate your shots out of 10.</p>
    </div>
  </header>

  <div class="layout">
    <section class="card">
      <div class="card-header">
        <h2>Add a sighting</h2>
        <button type="button" id="openRankingsBtn" class="rankings-btn">Rankings</button>
      </div>

      <div id="dropzone" class="dropzone">
        <div class="dropzone-icon">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M12 3L7 9h3v4h4V9h3l-5-6z" stroke="#e5e7eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M5 19h14" stroke="#e5e7eb" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
        <strong>Drop a birb photo</strong>
        <p>or click to browse ‚Äì JPG, PNG, HEIC etc.</p>
        <div class="chip"><span class="chip-dot"></span>Tip: close-up, well-lit shots rate best</div>
        <input id="fileInput" class="hidden-input" type="file" accept="image/*" />
      </div>

      <div id="preview" class="preview" style="display:none;">
        <img id="previewImg" alt="Preview" />
        <div class="preview-text">
          <div><strong id="previewName"></strong></div>
          <div style="margin-top:2px;">Ready to upload</div>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label for="birdName">Birb species</label>
          <div class="species-input-row">
            <input id="birdName" type="text" placeholder="Choose from checklist" autocomplete="off" readonly />
            <button type="button" id="openChecklistBtn" class="checklist-btn">Checklist</button>
          </div>
        </div>
        <div class="field">
          <label for="location">Where spotted</label>
          <input id="location" type="text" placeholder="e.g. Adelaide Botanic Gardens, SA" autocomplete="off" />
        </div>
        <div class="field">
          <label for="uploadedBy">Uploaded by</label>
          <input id="uploadedBy" type="text" placeholder="Your name or nickname" autocomplete="off" />
        </div>
      </div>

      <div class="actions-row">
        <div class="text-muted" id="statusText">All uploads are public. Please keep it friendly.</div>
        <button id="uploadBtn" class="btn-primary"><span>‚Üë</span>Save sighting</button>
      </div>

      <div id="errorMsg" class="error-message" style="display:none;"></div>
      <div id="successMsg" class="success-message" style="display:none;"></div>
    </section>

    <section class="card">
      <div class="gallery-header">
        <div>
          <h2>Latest birbs</h2>
          <small id="galleryCountLabel">Loading sightings‚Ä¶</small>
        </div>
        <div class="filter-badges">
          <button id="sortModeBtn" class="filter-badge sort-btn" type="button">
            <span id="sortModeLabel">Newest first</span> ‚ñæ
          </button>
          <span class="filter-badge">Ratings use ü¶ú out of 10</span>
        </div>

        <div id="sortMenu" class="sort-menu">
          <button class="sort-option" data-mode="newest">
            <span>Newest first</span>
            <span class="hint">Latest uploads on top</span>
          </button>
          <button class="sort-option" data-mode="highestRated">
            <span>Highest rated</span>
            <span class="hint">Best average /10</span>
          </button>
          <button class="sort-option" data-mode="mostValuable">
            <span>Most valuable</span>
            <span class="hint">Rating √ó rarity multiplier</span>
          </button>
          <button class="sort-option" data-mode="rarity">
            <span>Rarity</span>
            <span class="hint">Super rare ‚Üí very common</span>
          </button>
          <button class="sort-option" data-mode="oldest">
            <span>Oldest first</span>
            <span class="hint">Archive from the beginning</span>
          </button>
        </div>
      </div>

      <!-- New birbs banner -->
      <div id="newBirbsBanner" class="new-birbs-banner" style="display:none;"></div>

      <!-- Pager -->
      <div id="pager" class="pager" style="display:none;">
        <button id="prevPageBtn" class="pager-btn" type="button">‚Üê Prev</button>
        <div id="pagerLabel" class="pager-label">Page 1 of 1</div>
        <button id="nextPageBtn" class="pager-btn" type="button">Next ‚Üí</button>
      </div>

      <div id="galleryEmpty" class="gallery-empty" style="display:none;">
        No birb photos yet. Upload the very first sighting and start the flock.
      </div>

      <div id="galleryGrid" class="gallery-grid"></div>
    </section>
  </div>

  <footer>Hornithological Baes ¬∑ Firebase ¬∑ GitHub Pages</footer>
</div>

<!-- Species checklist overlay -->
<div id="speciesOverlay" class="species-overlay">
  <div class="species-panel">
    <div class="species-panel-header">
      <div>
        <h3>Select birb species</h3>
        <p>Search and tap a species to fill the form. Species you've already logged are marked as seen.</p>
      </div>
      <button type="button" id="closeSpeciesOverlayBtn" class="species-close-btn">Close</button>
    </div>
    <div id="speciesTally" class="species-tally">
      Species checklist loading‚Ä¶
    </div>
    <div class="species-search-row">
      <input id="speciesSearch" type="text" placeholder="Search Australian birb species‚Ä¶" />
    </div>
    <button type="button" class="merlin-help" id="merlinSmartBtn">
      Not sure what species? <strong>Identify it in Merlin Bird ID</strong> ‚Üí
    </button>
    <div id="speciesList" class="species-list"></div>
  </div>
</div>

<!-- Rating modal -->
<div id="ratingModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Rate this birb</h3>
      <p>Pick a score out of 10.</p>
    </div>
    <div class="rating-options">
      <button class="rating-option" data-value="1"><span class="emoji">ü¶ú</span><span>1</span></button>
      <button class="rating-option" data-value="2"><span class="emoji">ü¶ú</span><span>2</span></button>
      <button class="rating-option" data-value="3"><span class="emoji">ü¶ú</span><span>3</span></button>
      <button class="rating-option" data-value="4"><span class="emoji">ü¶ú</span><span>4</span></button>
      <button class="rating-option" data-value="5"><span class="emoji">ü¶ú</span><span>5</span></button>
      <button class="rating-option" data-value="6"><span class="emoji">ü¶ú</span><span>6</span></button>
      <button class="rating-option" data-value="7"><span class="emoji">ü¶ú</span><span>7</span></button>
      <button class="rating-option" data-value="8"><span class="emoji">ü¶ú</span><span>8</span></button>
      <button class="rating-option" data-value="9"><span class="emoji">ü¶ú</span><span>9</span></button>
      <button class="rating-option" data-value="10"><span class="emoji">ü¶ú</span><span>10</span></button>
    </div>
    <div class="modal-footer">
      <button id="ratingModalCancel" class="modal-cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- Comments modal -->
<div id="commentsModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3 id="commentsTitle">Comments</h3>
      <p id="commentsSubtitle">Comments for this sighting (only visible when opened).</p>
    </div>

    <div id="commentsList" class="comments-list"></div>

    <div class="comment-compose">
      <textarea id="commentInput" class="comment-input" maxlength="500" placeholder="Add a comment‚Ä¶"></textarea>
      <div class="modal-footer" style="justify-content:space-between;">
        <button id="commentsClose" class="modal-cancel">Close</button>
        <button id="commentSend" class="comment-send">Post comment</button>
      </div>
    </div>
  </div>
</div>

<!-- Rankings modal -->
<div id="rankingsModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Rankings</h3>
      <p>Points by uploader (rating √ó rarity multiplier).</p>
    </div>

    <div class="modal-footer" style="justify-content:space-between;margin-top:6px;">
      <button id="rankingsRulesBtn" class="modal-accent" type="button">Scoring rules</button>
      <button id="rankingsClose" class="modal-cancel" type="button">Close</button>
    </div>

    <div id="rankingsList" class="rankings-list" style="margin-top:10px;">
      <div class="rankings-row rankings-head">
        <div>#</div><div>Uploader</div><div class="right">Uploads</div><div class="right">Points</div>
      </div>
      <div class="rankings-empty">Loading‚Ä¶</div>
    </div>
  </div>
</div>

<!-- Scoring rules modal -->
<div id="scoringModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Scoring rules</h3>
      <p>How points are calculated.</p>
    </div>

    <div class="rules-box">
      Each post earns:
      <div><code>points = (average rating out of 10) √ó (rarity multiplier)</code></div>
      <ul class="rules-list">
        <li>Super rare multiplier: <strong>25</strong></li>
        <li>Rare multiplier: <strong>15</strong></li>
        <li>Uncommon multiplier: <strong>8</strong></li>
        <li>Common multiplier: <strong>4</strong></li>
        <li>Very common multiplier: <strong>1</strong></li>
        <li>No ratings yet ‚Üí that post contributes <strong>0</strong> points</li>
        <li>Total points = sum of all your post points</li>
      </ul>
    </div>

    <div class="modal-footer">
      <button id="scoringClose" class="modal-cancel" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Fullscreen image overlay -->
<div id="imageFullscreenOverlay" class="image-fullscreen-overlay">
  <img id="imageFullscreenImg" src="" alt="Full-size birb">
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyDkmpTvNw1IOCxS1NFr9_fqkZY73N0f1P8",
    authDomain: "hornithological-baes.firebaseapp.com",
    projectId: "hornithological-baes",
    storageBucket: "hornithological-baes.firebasestorage.app",
    messagingSenderId: "909306883752",
    appId: "1:909306883752:web:daf920bede5aa6fadf1c9d",
    measurementId: "G-T9VSSKQS0Q"
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, onSnapshot, orderBy, query, doc, getDoc, getDocs,
    updateDoc, deleteDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
  import {
    getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Device ID
  const deviceKey = "hb_device_id_v1";
  let deviceId = localStorage.getItem(deviceKey);
  if (!deviceId) {
    deviceId = (crypto.randomUUID ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2)));
    localStorage.setItem(deviceKey, deviceId);
  }

  // Pagination (9 per screen)
  const PAGE_SIZE = 9;
  let currentPage = 1;

  // "Last seen" timestamp for new birbs banner
  const lastSeenKey = "hb_last_seen_ts_v1";
  let lastSeenTs = 0;
  try {
    const raw = localStorage.getItem(lastSeenKey);
    if (raw) lastSeenTs = parseInt(raw, 10) || 0;
  } catch { lastSeenTs = 0; }
  let newestTs = 0;
  let newSinceLastSeenCount = 0;
  let initialSnapshotHandled = false;

  // Rankings: multipliers
  const POINTS_BY_RARITY = {
    super_rare: 25,
    rare: 15,
    uncommon: 8,
    common: 4,
    very_common: 1
  };

  // Species JSON and rarity helpers
  let SPECIES = [];
  let SPECIES_INDEX = new Map();
  let speciesLoaded = false;
  let speciesLoadError = false;

  const normalizeName = (s) => (s || "")
    .trim()
    .toLowerCase()
    .replace(/[‚Äô‚Äò]/g, "'")
    .replace(/[‚Äì‚Äî]/g, "-")
    .replace(/\s+/g, " ");

  function normalizeRarity(r) {
    const v = (r || "").toString().trim().toLowerCase();
    const map = {
      "super rare": "super_rare",
      "super-rare": "super_rare",
      "super_rare": "super_rare",
      "rare": "rare",
      "uncommon": "uncommon",
      "common": "common",
      "very common": "very_common",
      "very-common": "very_common",
      "very_common": "very_common",
      "unknown": "unknown"
    };
    return map[v] || "unknown";
  }

  function rarityLabel(token) {
    switch (token) {
      case "super_rare": return "Super rare";
      case "rare": return "Rare";
      case "uncommon": return "Uncommon";
      case "common": return "Common";
      case "very_common": return "Very common";
      default: return "";
    }
  }

  function getRarityForSpecies(speciesName) {
    const entry = SPECIES_INDEX.get(normalizeName(speciesName));
    if (!entry) return null;
    const rarity = normalizeRarity(entry.rarity);
    if (!rarity || rarity === "unknown") return null;
    return rarity;
  }

  async function loadSpeciesJson() {
    try {
      const res = await fetch("species-au.json", { cache: "no-cache" });
      if (!res.ok) throw new Error("Failed to fetch species JSON");
      const data = await res.json();

      let list = [];
      if (Array.isArray(data)) list = data;
      else if (Array.isArray(data.species)) list = data.species;

      SPECIES = list.map((x) => {
        if (typeof x === "string") return { name: x, rarity: "unknown" };
        return { name: x?.name || "", rarity: normalizeRarity(x?.rarity) };
      }).filter(x => x.name && x.name.trim().length > 0);

      SPECIES_INDEX = new Map();
      for (const item of SPECIES) {
        SPECIES_INDEX.set(normalizeName(item.name), { name: item.name.trim(), rarity: normalizeRarity(item.rarity) });
      }

      speciesLoaded = true;
      speciesLoadError = false;
      updateSpeciesTally();
      renderSpeciesList(speciesSearch.value);
    } catch (err) {
      console.error("Error loading species-au.json", err);
      speciesLoaded = true;
      speciesLoadError = true;
      updateSpeciesTally();
      renderSpeciesList(speciesSearch.value);
    }
  }
  loadSpeciesJson();

  const photosCol = collection(db, "birdPhotos");

  // DOM
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("preview");
  const previewImg = document.getElementById("previewImg");
  const previewName = document.getElementById("previewName");
  const birdNameInput = document.getElementById("birdName");
  const locationInput = document.getElementById("location");
  const uploadedByInput = document.getElementById("uploadedBy");
  const uploadBtn = document.getElementById("uploadBtn");
  const statusText = document.getElementById("statusText");
  const errorMsg = document.getElementById("errorMsg");
  const successMsg = document.getElementById("successMsg");
  const galleryGrid = document.getElementById("galleryGrid");
  const galleryEmpty = document.getElementById("galleryEmpty");
  const galleryCountLabel = document.getElementById("galleryCountLabel");
  const newBirbsBanner = document.getElementById("newBirbsBanner");

  // Pager DOM
  const pager = document.getElementById("pager");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const pagerLabel = document.getElementById("pagerLabel");

  const ratingModalBackdrop = document.getElementById("ratingModalBackdrop");
  const ratingModalCancel = document.getElementById("ratingModalCancel");
  const ratingOptionButtons = ratingModalBackdrop.querySelectorAll(".rating-option");

  const commentsModalBackdrop = document.getElementById("commentsModalBackdrop");
  const commentsTitle = document.getElementById("commentsTitle");
  const commentsSubtitle = document.getElementById("commentsSubtitle");
  const commentsList = document.getElementById("commentsList");
  const commentInput = document.getElementById("commentInput");
  const commentSend = document.getElementById("commentSend");
  const commentsClose = document.getElementById("commentsClose");

  const speciesOverlay = document.getElementById("speciesOverlay");
  const speciesListEl = document.getElementById("speciesList");
  const speciesSearch = document.getElementById("speciesSearch");
  const openChecklistBtn = document.getElementById("openChecklistBtn");
  const closeSpeciesOverlayBtn = document.getElementById("closeSpeciesOverlayBtn");
  const speciesTallyEl = document.getElementById("speciesTally");

  const merlinSmartBtn = document.getElementById("merlinSmartBtn");

  // Rankings DOM
  const openRankingsBtn = document.getElementById("openRankingsBtn");
  const rankingsModalBackdrop = document.getElementById("rankingsModalBackdrop");
  const rankingsClose = document.getElementById("rankingsClose");
  const rankingsList = document.getElementById("rankingsList");
  const rankingsRulesBtn = document.getElementById("rankingsRulesBtn");
  const scoringModalBackdrop = document.getElementById("scoringModalBackdrop");
  const scoringClose = document.getElementById("scoringClose");

  // Sorting DOM
  const sortModeBtn = document.getElementById("sortModeBtn");
  const sortModeLabel = document.getElementById("sortModeLabel");
  const sortMenu = document.getElementById("sortMenu");

  // Fullscreen overlay DOM
  const imageFsOverlay = document.getElementById("imageFullscreenOverlay");
  const imageFsImg = document.getElementById("imageFullscreenImg");

  // Open Merlin Bird ID in app / store / web
  function openMerlinSmart() {
    const merlinWeb = "https://merlin.allaboutbirds.org/";
    const iosStore = "https://apps.apple.com/au/app/merlin-bird-id-by-cornell-lab/id773457673";
    const playStore = "https://play.google.com/store/apps/details?id=com.labs.merlinbirdid.app&hl=en_AU";

    const ua = navigator.userAgent || "";
    const isAndroid = /Android/i.test(ua);
    const isIOS = /iPhone|iPad|iPod/i.test(ua);

    const androidIntent =
      "intent://merlin.allaboutbirds.org/#Intent;scheme=https;package=com.labs.merlinbirdid.app;" +
      "S.browser_fallback_url=" + encodeURIComponent(playStore) + ";end";

    const fallback = isIOS ? iosStore : isAndroid ? playStore : "https://merlin.allaboutbirds.org/download/";
    const start = Date.now();

    window.location.href = isAndroid ? androidIntent : merlinWeb;

    setTimeout(() => {
      if (document.visibilityState === "visible" && (Date.now() - start) > 700) {
        window.location.href = fallback;
      }
    }, 1100);
  }
  if (merlinSmartBtn) merlinSmartBtn.addEventListener("click", openMerlinSmart);

  let selectedFile = null;
  let ratingTargetPhotoId = null;
  let currentSeenSpecies = new Set();

  // Comments state
  let commentsTargetPhotoId = null;
  let commentsUnsub = null;

  // Rankings state
  let latestDocsForRankings = [];

  // Sorting state
  let currentPhotos = [];
  let sortMode = "newest";
  const SORT_LABELS = {
    newest: "Newest first",
    highestRated: "Highest rated",
    mostValuable: "Most valuable",
    rarity: "Rarity",
    oldest: "Oldest first"
  };

  // Fullscreen helpers
  function openImageFullscreen(url) {
    if (!url) return;
    imageFsImg.src = url;
    imageFsOverlay.classList.add("show");
  }
  function closeImageFullscreen() {
    imageFsOverlay.classList.remove("show");
    imageFsImg.src = "";
  }
  imageFsOverlay.addEventListener("click", () => closeImageFullscreen());

  // Drag/drop
  function handleFiles(files) {
    if (!files || !files.length) return;
    const file = files[0];
    if (!file.type.startsWith("image/")) return showError("Please upload an image file.");
    selectedFile = file;
    previewImg.src = URL.createObjectURL(file);
    previewName.textContent = file.name;
    preview.style.display = "flex";
    hideError(); hideSuccess();
  }

  dropzone.addEventListener("click", () => fileInput.click());
  dropzone.addEventListener("dragover", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.add("dragover"); });
  dropzone.addEventListener("dragleave", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("dragover"); });
  dropzone.addEventListener("drop", (e) => { e.preventDefault(); e.stopPropagation(); dropzone.classList.remove("dragover"); handleFiles(e.dataTransfer.files); });
  fileInput.addEventListener("change", (e) => handleFiles(e.target.files));

  // Downscale uploads to keep page fast + avoid huge images
  async function prepareUploadFile(file) {
    const MAX_DIM = 1920;   // max longest side
    const QUALITY = 0.86;   // jpeg quality

    // Only re-encode for these (HEIC/HEIF often needs special handling, so keep as-is)
    if (!/^image\/(jpeg|jpg|png|webp)$/i.test(file.type)) return file;

    const safeBase = (file.name || "upload").replace(/\.[^.]+$/, "");
    const outName = `${safeBase}.jpg`;

    // Try createImageBitmap first (fast on most browsers)
    try {
      const bmp = await createImageBitmap(file);
      const scale = Math.min(1, MAX_DIM / Math.max(bmp.width, bmp.height));
      if (scale === 1) { bmp.close?.(); return file; }

      const canvas = document.createElement("canvas");
      canvas.width = Math.round(bmp.width * scale);
      canvas.height = Math.round(bmp.height * scale);

      const ctx = canvas.getContext("2d", { alpha: false });
      ctx.drawImage(bmp, 0, 0, canvas.width, canvas.height);
      bmp.close?.();

      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", QUALITY));
      if (!blob) return file;
      return new File([blob], outName, { type: "image/jpeg" });
    } catch {
      // Fallback: Image element decode (works on Safari cases where createImageBitmap can be flaky)
      try {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.decoding = "async";
        img.src = url;

        await new Promise((resolve, reject) => {
          img.onload = () => resolve();
          img.onerror = () => reject(new Error("Image decode failed"));
        });

        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const scale = Math.min(1, MAX_DIM / Math.max(w, h));
        if (scale === 1) { URL.revokeObjectURL(url); return file; }

        const canvas = document.createElement("canvas");
        canvas.width = Math.round(w * scale);
        canvas.height = Math.round(h * scale);
        const ctx = canvas.getContext("2d", { alpha: false });
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", QUALITY));
        if (!blob) return file;
        return new File([blob], outName, { type: "image/jpeg" });
      } catch {
        return file;
      }
    }
  }

  // Upload
  uploadBtn.addEventListener("click", async () => {
    hideError(); hideSuccess();
    const birdName = birdNameInput.value.trim();
    const location = locationInput.value.trim();
    const uploadedBy = uploadedByInput.value.trim();

    if (!selectedFile) return showError("Select or drop a birb photo first.");
    if (!birdName) { showError("Choose a birb species from the checklist."); birdNameInput.focus(); return; }
    if (!location) { showError("Enter where the photo was taken."); locationInput.focus(); return; }

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Uploading‚Ä¶";
    statusText.textContent = "Optimising image, uploading, then saving to the database‚Ä¶";

    try {
      const uploadFile = await prepareUploadFile(selectedFile);

      const unique = (crypto.randomUUID ? crypto.randomUUID() : (String(Date.now()) + "_" + Math.random().toString(16).slice(2)));
      const storagePath = `birdPhotos/${Date.now()}_${unique}.jpg`;
      const imgRef = storageRef(storage, storagePath);

      await uploadBytes(imgRef, uploadFile);
      const url = await getDownloadURL(imgRef);

      await addDoc(photosCol, {
        birdName,
        location,
        uploadedBy: uploadedBy || null,
        imageUrl: url,
        storagePath,
        createdAt: serverTimestamp(),
        ratingTotal: 0,
        ratingCount: 0,
        ownerDeviceId: deviceId,
        originalFileName: selectedFile.name || null
      });

      showSuccess("Sighting saved. Check the gallery on the right.");
      resetForm();
      currentPage = 1; // show newest page after upload
    } catch (err) {
      console.error(err);
      showError("Upload failed. Check Firebase config, rules, or bucket name.");
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.innerHTML = "<span>‚Üë</span>Save sighting";
      statusText.textContent = "All uploads are public. Please keep it friendly.";
    }
  });

  function resetForm() {
    selectedFile = null;
    fileInput.value = "";
    birdNameInput.value = "";
    locationInput.value = "";
    uploadedByInput.value = "";
    preview.style.display = "none";
  }

  function showError(msg){ errorMsg.textContent = msg; errorMsg.style.display = "block"; }
  function hideError(){ errorMsg.textContent = ""; errorMsg.style.display = "none"; }
  function showSuccess(msg){ successMsg.textContent = msg; successMsg.style.display = "block"; setTimeout(()=>successMsg.style.display="none",3500); }
  function hideSuccess(){ successMsg.textContent = ""; successMsg.style.display = "none"; }

  // Ratings stored locally per browser
  const ratingsKey = "hornithological_baes_ratings_v1";
  let localRatings = {};
  try { const stored = localStorage.getItem(ratingsKey); if (stored) localRatings = JSON.parse(stored); } catch { localRatings = {}; }
  function saveLocalRatings(){ try { localStorage.setItem(ratingsKey, JSON.stringify(localRatings)); } catch {} }

  // Firestore listener
  const qPhotos = query(photosCol, orderBy("createdAt", "desc"));

  onSnapshot(qPhotos, (snapshot) => {
    const docs = [];
    snapshot.forEach(docSnap => docs.push({ id: docSnap.id, data: docSnap.data() }));

    latestDocsForRankings = docs;
    currentPhotos = docs;

    // New birbs banner logic
    let maxTs = 0;
    let countNew = 0;
    docs.forEach(({ data }) => {
      const d = getCreatedDate(data);
      if (!d) return;
      const t = d.getTime();
      if (t > maxTs) maxTs = t;
      if (lastSeenTs && t > lastSeenTs) countNew++;
    });

    if (!initialSnapshotHandled) {
      initialSnapshotHandled = true;
      if (!lastSeenTs && maxTs) {
        lastSeenTs = maxTs;
        try { localStorage.setItem(lastSeenKey, String(lastSeenTs)); } catch {}
        countNew = 0;
      }
    }

    newestTs = maxTs;
    newSinceLastSeenCount = countNew;
    updateNewBirbsBanner();

    if (rankingsModalBackdrop.classList.contains("show")) {
      renderRankings(buildRankings(latestDocsForRankings));
    }

    renderGallery();
  });

  function getCreatedDate(data) {
    if (data.createdAt && data.createdAt.toDate) return data.createdAt.toDate();
    return null;
  }

  function updateSpeciesTally() {
    if (!speciesTallyEl) return;

    if (!speciesLoaded && !speciesLoadError) {
      speciesTallyEl.textContent = "Species checklist loading‚Ä¶";
      return;
    }
    if (speciesLoadError) {
      speciesTallyEl.textContent = "Tally unavailable (species list not loaded).";
      return;
    }
    if (!Array.isArray(SPECIES) || !SPECIES.length) {
      speciesTallyEl.textContent = "No species configured.";
      return;
    }

    let seen = 0;
    for (const item of SPECIES) {
      if (currentSeenSpecies.has(item.name)) seen++;
    }
    const unseen = SPECIES.length - seen;

    speciesTallyEl.innerHTML =
      `<span class="seen">Seen: ${seen}</span> ¬∑ <span class="unseen">Unseen: ${unseen}</span>`;
  }

  // "New birbs since you last visited" banner update
  function updateNewBirbsBanner() {
    if (!newBirbsBanner) return;

    if (!newSinceLastSeenCount || newSinceLastSeenCount <= 0) {
      newBirbsBanner.style.display = "none";
      newBirbsBanner.textContent = "";
      return;
    }

    const label = newSinceLastSeenCount === 1
      ? "1 new birb sighting since you last visited"
      : `${newSinceLastSeenCount} new birb sightings since you last visited`;

    newBirbsBanner.innerHTML =
      `<span>${escapeHtml(label)}</span><span class="secondary">Tap to jump to latest</span>`;
    newBirbsBanner.style.display = "flex";
  }

  if (newBirbsBanner) {
    newBirbsBanner.addEventListener("click", () => {
      if (newestTs) {
        lastSeenTs = newestTs;
        try { localStorage.setItem(lastSeenKey, String(lastSeenTs)); } catch {}
      }
      newSinceLastSeenCount = 0;
      currentPage = 1;
      updateNewBirbsBanner();
      renderGallery();
      window.scrollTo({ top: 0, behavior: "smooth" });
    });
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") updateNewBirbsBanner();
  });

  // Pager helpers
  function scrollGalleryIntoView() {
    const el = document.querySelector(".gallery-header");
    if (el && el.scrollIntoView) el.scrollIntoView({ behavior: "smooth", block: "start" });
    else window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function updatePager(totalItems) {
    if (!pager) return;
    const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    const show = totalItems > PAGE_SIZE;
    pager.style.display = show ? "flex" : "none";

    if (pagerLabel) pagerLabel.textContent = `Page ${currentPage} of ${totalPages}`;
    if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
    if (nextPageBtn) nextPageBtn.disabled = currentPage >= totalPages;
  }

  if (prevPageBtn) {
    prevPageBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage -= 1;
        renderGallery();
        scrollGalleryIntoView();
      }
    });
  }

  if (nextPageBtn) {
    nextPageBtn.addEventListener("click", () => {
      const totalPages = Math.max(1, Math.ceil((currentPhotos?.length || 0) / PAGE_SIZE));
      if (currentPage < totalPages) {
        currentPage += 1;
        renderGallery();
        scrollGalleryIntoView();
      }
    });
  }

  function multiplierForSpecies(speciesName){
    const rarity = getRarityForSpecies(speciesName);
    return POINTS_BY_RARITY[rarity] ?? 1;
  }

  function renderGallery() {
    galleryGrid.innerHTML = "";
    galleryEmpty.style.display = "none";

    if (!currentPhotos.length) {
      galleryEmpty.style.display = "block";
      galleryCountLabel.textContent = "No sightings yet.";
      currentSeenSpecies = new Set();
      updateSpeciesTally();
      updatePager(0);
      return;
    }

    galleryCountLabel.textContent = `${currentPhotos.length} sighting${currentPhotos.length > 1 ? "s" : ""}`;

    // Build speciesCounts across all docs for repeat-species tag
    const speciesCounts = {};
    currentPhotos.forEach(({ data }) => {
      const name = (data.birdName || "Unknown birb").trim();
      if (!name) return;
      speciesCounts[name] = (speciesCounts[name] || 0) + 1;
    });
    currentSeenSpecies = new Set(Object.keys(speciesCounts));
    updateSpeciesTally();

    // Sort copy based on current sort mode
    const docs = currentPhotos.slice();

    const rarityOrder = {
      super_rare: 0,
      rare: 1,
      uncommon: 2,
      common: 3,
      very_common: 4,
      none: 5
    };

    function avgRatingOf(data) {
      const total = Number(data.ratingTotal || 0);
      const count = Number(data.ratingCount || 0);
      return count > 0 ? total / count : 0;
    }

    function multiplierForSpeciesInternal(speciesName){
      const rarity = getRarityForSpecies(speciesName);
      return POINTS_BY_RARITY[rarity] ?? 1;
    }

    docs.sort((a, b) => {
      const da = a.data;
      const db = b.data;

      const dateA = getCreatedDate(da);
      const dateB = getCreatedDate(db);
      const tsA = dateA ? dateA.getTime() : 0;
      const tsB = dateB ? dateB.getTime() : 0;

      const avgA = avgRatingOf(da);
      const avgB = avgRatingOf(db);

      const multA = multiplierForSpeciesInternal(da.birdName || "");
      const multB = multiplierForSpeciesInternal(db.birdName || "");
      const valA = avgA * multA;
      const valB = avgB * multB;

      const rA = getRarityForSpecies(da.birdName || "") || "none";
      const rB = getRarityForSpecies(db.birdName || "") || "none";
      const roA = rarityOrder[rA] ?? rarityOrder.none;
      const roB = rarityOrder[rB] ?? rarityOrder.none;

      if (sortMode === "newest") {
        if (tsA !== tsB) return tsB - tsA;
        return 0;
      }
      if (sortMode === "oldest") {
        if (tsA !== tsB) return tsA - tsB;
        return 0;
      }
      if (sortMode === "highestRated") {
        if (avgB !== avgA) return avgB - avgA;
        const cntA = Number(da.ratingCount || 0);
        const cntB = Number(db.ratingCount || 0);
        if (cntB !== cntA) return cntB - cntA;
        return tsB - tsA;
      }
      if (sortMode === "mostValuable") {
        if (valB !== valA) return valB - valA;
        const cntA = Number(da.ratingCount || 0);
        const cntB = Number(db.ratingCount || 0);
        if (cntB !== cntA) return cntB - cntA;
        return tsB - tsA;
      }
      if (sortMode === "rarity") {
        if (roA !== roB) return roA - roB;
        return tsB - tsA;
      }
      return tsB - tsA;
    });

    // Pagination slice
    updatePager(docs.length);
    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const pageDocs = docs.slice(startIdx, startIdx + PAGE_SIZE);

    pageDocs.forEach(({ id, data }) => {
      const imgUrl = data.imageUrl || "";
      const birdName = data.birdName || "Unknown birb";
      const location = data.location || "Unknown location";
      const uploadedBy = data.uploadedBy || "Anonymous";
      const ratingTotal = data.ratingTotal || 0;
      const ratingCount = data.ratingCount || 0;
      const averageRating = ratingCount > 0 ? ratingTotal / ratingCount : 0;
      const rounded = ratingCount > 0 ? Math.round(averageRating * 10) / 10 : 0;
      const filledParrots = Math.round(averageRating || 0);

      const isRepeat = (speciesCounts[birdName] || 0) > 1;
      const repeatTagHtml = isRepeat ? `<div class="repeat-species-tag">Repeat species</div>` : "";

      const createdAt = data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : null;
      const timeAgo = createdAt ? formatTimeAgo(createdAt) : "Just now";

      const parrotsHtml = Array.from({ length: 10 }, (_, idx) => {
        const i = idx + 1;
        return `<span class="parrot ${i <= filledParrots ? "filled" : ""}">ü¶ú</span>`;
      }).join("");

      const rarity = getRarityForSpecies(birdName);
      const rarityText = rarity ? rarityLabel(rarity) : "";
      const rarityHtml = rarity
        ? `<div class="rarity-badge-wrap" title="${escapeHtml(rarityText)}">
             <img class="rarity-badge" src="${rarity}.png" alt="${escapeHtml(rarityText)} badge" loading="lazy" />
           </div>`
        : "";

      const isOwner = data.ownerDeviceId && data.ownerDeviceId === deviceId;
      const rateBtnHtml = isOwner
        ? `<button class="rate-btn" data-photo-id="${id}" disabled title="You can't rate your own post">Your post</button>`
        : `<button class="rate-btn" data-photo-id="${id}">Tap here to rate /10</button>`;

      const card = document.createElement("article");
      card.className = "photo-card";
      card.dataset.photoId = id;

      card.innerHTML = `
        <div class="photo-thumb">
          <img src="${imgUrl}" alt="${escapeHtml(birdName)}" loading="lazy" />
          ${rarityHtml}
          <button
            type="button"
            class="fullscreen-btn"
            data-full-url="${imgUrl}"
            title="View full screen"
            aria-label="View full screen"
          >
            ‚§¢
          </button>
        </div>
        <div class="photo-body">
          <div class="photo-title">${escapeHtml(birdName)}</div>
          <div class="photo-uploaded-by">Uploaded by ${escapeHtml(uploadedBy)}</div>
          <div class="photo-location-row">
            <div class="photo-location">${escapeHtml(location)}</div>
            ${repeatTagHtml}
          </div>
          <div class="photo-meta-row">
            <div class="rating-wrapper">
              <div class="parrots">${parrotsHtml}</div>
              <div class="rating-text">
                ${ratingCount === 0 ? "Not rated yet ‚Äì be first." : `${rounded.toFixed(1)} / 10 ¬∑ ${ratingCount} rating${ratingCount > 1 ? "s" : ""}`}
              </div>
            </div>
            <span class="time-tag">${timeAgo}</span>
          </div>
          <div class="card-footer-row">
            <div class="footer-actions-left">
              ${rateBtnHtml}
              <button class="comments-btn" data-photo-id="${id}" data-bird-name="${escapeHtml(birdName)}">Comments</button>
            </div>
            <button class="delete-btn" data-photo-id="${id}">üóë Delete</button>
          </div>
        </div>
      `;
      galleryGrid.appendChild(card);
    });

    if (speciesOverlay.classList.contains("show")) renderSpeciesList(speciesSearch.value);
  }

  // Rating modal
  function openRatingModal(photoId){ ratingTargetPhotoId = photoId; ratingModalBackdrop.classList.add("show"); }
  function closeRatingModal(){ ratingTargetPhotoId = null; ratingModalBackdrop.classList.remove("show"); }
  ratingModalCancel.addEventListener("click", closeRatingModal);
  ratingModalBackdrop.addEventListener("click", (e) => { if (e.target === ratingModalBackdrop) closeRatingModal(); });

  ratingOptionButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!ratingTargetPhotoId) return;
      const value = parseInt(btn.dataset.value, 10);
      if (!value) return;
      try { await ratePhoto(ratingTargetPhotoId, value); }
      catch (err) { console.error(err); showError("Could not save rating. Check Firebase rules."); }
      finally { closeRatingModal(); }
    });
  });

  async function ratePhoto(photoId, ratingValue) {
    const docRef = doc(db, "birdPhotos", photoId);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;

    const data = snap.data();
    if (data.ownerDeviceId && data.ownerDeviceId === deviceId) return;

    let ratingTotal = data.ratingTotal || 0;
    let ratingCount = data.ratingCount || 0;

    const prevRating = localRatings[photoId];
    if (!prevRating) {
      ratingTotal += ratingValue;
      ratingCount += 1;
    } else {
      ratingTotal = ratingTotal - prevRating + ratingValue;
    }

    await updateDoc(docRef, { ratingTotal, ratingCount });

    localRatings[photoId] = ratingValue;
    saveLocalRatings();
  }

  // Comments modal
  function openCommentsModal(photoId, birdName) {
    closeCommentsModal();
    commentsTargetPhotoId = photoId;

    commentsTitle.textContent = `Comments ¬∑ ${birdName || "Birb"}`;
    commentsSubtitle.textContent = "Comments for this sighting (only visible when opened).";
    commentInput.value = "";
    commentsList.innerHTML = `<div class="comment-empty">Loading comments‚Ä¶</div>`;
    commentsModalBackdrop.classList.add("show");

    const commentsCol = collection(db, "birdPhotos", photoId, "comments");
    const q = query(commentsCol, orderBy("createdAt", "asc"));

    commentsUnsub = onSnapshot(
      q,
      (snap) => {
        const items = [];
        snap.forEach((d) => items.push({ id: d.id, data: d.data() }));

        commentsList.innerHTML = "";
        if (!items.length) {
          commentsList.innerHTML = `<div class="comment-empty">No comments yet. Be the first.</div>`;
          return;
        }

        for (const item of items) {
          const text = (item.data.text || "").toString();
          const dt = item.data.createdAt && item.data.createdAt.toDate ? item.data.createdAt.toDate() : null;
          const stamp = dt ? toDDMMYY(dt) : "--/--/--";
          const canDelete = item.data.deviceId && item.data.deviceId === deviceId;

          const el = document.createElement("div");
          el.className = "comment-item";
          el.innerHTML = `
            <div class="comment-meta">
              <div class="time">${escapeHtml(stamp)}</div>
              ${canDelete ? `<button class="comment-del" title="Delete comment" aria-label="Delete comment" data-comment-id="${item.id}">√ó</button>` : ``}
            </div>
            <div class="comment-text">${escapeHtml(text)}</div>
          `;
          commentsList.appendChild(el);
        }
      },
      (err) => {
        console.error("Comments listener error:", err);
        commentsList.innerHTML = `<div class="comment-empty">Can't load comments (Firestore permissions). Check Firestore Rules.</div>`;
      }
    );
  }

  function closeCommentsModal() {
    if (commentsUnsub) { try { commentsUnsub(); } catch {} }
    commentsUnsub = null;
    commentsTargetPhotoId = null;
    commentsModalBackdrop.classList.remove("show");
  }

  commentsClose.addEventListener("click", closeCommentsModal);
  commentsModalBackdrop.addEventListener("click", (e) => {
    if (e.target === commentsModalBackdrop) closeCommentsModal();
  });

  commentSend.addEventListener("click", async () => {
    hideError(); hideSuccess();
    if (!commentsTargetPhotoId) return;

    const text = (commentInput.value || "").trim();
    if (!text) return;

    commentSend.disabled = true;
    commentSend.textContent = "Posting‚Ä¶";
    try {
      const commentsCol = collection(db, "birdPhotos", commentsTargetPhotoId, "comments");
      await addDoc(commentsCol, { text, createdAt: serverTimestamp(), deviceId });
      commentInput.value = "";
      commentInput.focus();
    } catch (err) {
      console.error(err);
      showError("Could not post comment. Check Firebase rules.");
    } finally {
      commentSend.disabled = false;
      commentSend.textContent = "Post comment";
    }
  });

  commentsList.addEventListener("click", async (e) => {
    const btn = e.target.closest(".comment-del");
    if (!btn) return;
    if (!commentsTargetPhotoId) return;

    const commentId = btn.dataset.commentId;
    if (!commentId) return;

    if (!confirm("Delete this comment?")) return;

    try {
      await deleteDoc(doc(db, "birdPhotos", commentsTargetPhotoId, "comments", commentId));
    } catch (err) {
      console.error(err);
      showError("Could not delete comment. Check Firebase rules.");
    }
  });

  // Gallery buttons
  galleryGrid.addEventListener("click", async (e) => {
    const fsBtn = e.target.closest(".fullscreen-btn");
    if (fsBtn) {
      const url = fsBtn.dataset.fullUrl;
      if (url) openImageFullscreen(url);
      return;
    }

    const deleteBtn = e.target.closest(".delete-btn");
    if (deleteBtn) {
      const photoId = deleteBtn.dataset.photoId;
      if (!photoId) return;
      if (!window.confirm("Delete this sighting? This cannot be undone.")) return;
      try { await deletePhoto(photoId); }
      catch (err) { console.error(err); showError("Could not delete sighting. Check Firebase rules."); }
      return;
    }

    const rateBtn = e.target.closest(".rate-btn");
    if (rateBtn) {
      if (rateBtn.disabled) return;
      const photoId = rateBtn.dataset.photoId;
      if (!photoId) return;
      openRatingModal(photoId);
      return;
    }

    const commentsBtn = e.target.closest(".comments-btn");
    if (commentsBtn) {
      const photoId = commentsBtn.dataset.photoId;
      const birdName = commentsBtn.getAttribute("data-bird-name") || "Birb";
      if (!photoId) return;
      openCommentsModal(photoId, birdName);
      return;
    }
  });

  async function deleteCommentsForPhoto(photoId) {
    try {
      const commentsCol = collection(db, "birdPhotos", photoId, "comments");
      const snap = await getDocs(commentsCol);
      const deletions = [];
      snap.forEach((d) => deletions.push(deleteDoc(d.ref)));
      await Promise.all(deletions);
    } catch (e) {
      console.error("Error deleting comments:", e);
    }
  }

  async function deletePhoto(photoId) {
    const docRef = doc(db, "birdPhotos", photoId);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;

    const data = snap.data();
    const storagePath = data.storagePath;

    if (storagePath) {
      try { await deleteObject(storageRef(storage, storagePath)); }
      catch (e) { console.error("Error deleting file from storage:", e); }
    }

    await deleteCommentsForPhoto(photoId);

    delete localRatings[photoId];
    saveLocalRatings();
    await deleteDoc(docRef);
  }

  // Species overlay
  function openSpeciesOverlay(){
    speciesOverlay.classList.add("show");
    speciesSearch.value = "";
    renderSpeciesList("");
    setTimeout(()=>speciesSearch.focus(), 50);
  }
  function closeSpeciesOverlay(){ speciesOverlay.classList.remove("show"); }

  openChecklistBtn.addEventListener("click", openSpeciesOverlay);
  birdNameInput.addEventListener("click", openSpeciesOverlay);
  closeSpeciesOverlayBtn.addEventListener("click", closeSpeciesOverlay);
  speciesOverlay.addEventListener("click", (e) => { if (e.target === speciesOverlay) closeSpeciesOverlay(); });
  speciesSearch.addEventListener("input", (e) => renderSpeciesList(e.target.value));

  function renderSpeciesList(filter) {
    const term = (filter || "").toLowerCase().trim();
    speciesListEl.innerHTML = "";

    if (!speciesLoaded && !speciesLoadError) {
      const loading = document.createElement("div");
      loading.className = "species-empty";
      loading.textContent = "Loading species list‚Ä¶";
      speciesListEl.appendChild(loading);
      updateSpeciesTally();
      return;
    }

    if (speciesLoadError) {
      const err = document.createElement("div");
      err.className = "species-empty";
      err.textContent = "Could not load species-au.json. Check the file exists in the same folder.";
      speciesListEl.appendChild(err);
      updateSpeciesTally();
      return;
    }

    const filtered = SPECIES
      .map(x => x.name)
      .filter(name => (name || "").toLowerCase().includes(term));

    if (!filtered.length) {
      const empty = document.createElement("div");
      empty.className = "species-empty";
      empty.textContent = "No matches. Try a different spelling.";
      speciesListEl.appendChild(empty);
      updateSpeciesTally();
      return;
    }

    filtered.forEach(name => {
      const isSeen = currentSeenSpecies.has(name);
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "species-item" + (isSeen ? " seen" : "");
      btn.dataset.name = name;
      btn.innerHTML = `<span class="species-name">${escapeHtml(name)}</span>${isSeen ? '<span class="species-status">Seen</span>' : ""}`;
      speciesListEl.appendChild(btn);
    });

    updateSpeciesTally();
  }

  speciesListEl.addEventListener("click", (e) => {
    const item = e.target.closest(".species-item");
    if (!item) return;
    birdNameInput.value = item.dataset.name || "";
    closeSpeciesOverlay();
  });

  // Rankings
  function buildRankings(docs){
    const map = new Map();

    for (const { data } of docs){
      const uploader = (data.uploadedBy || "").trim() || "Unknown";
      const species = (data.birdName || "").trim();

      const ratingTotal = Number(data.ratingTotal || 0);
      const ratingCount = Number(data.ratingCount || 0);
      const avgRating = ratingCount > 0 ? (ratingTotal / ratingCount) : 0;

      const mult = multiplierForSpecies(species);
      const postPoints = avgRating * mult;

      const curr = map.get(uploader) || { uploads: 0, points: 0 };
      curr.uploads += 1;
      curr.points += postPoints;
      map.set(uploader, curr);
    }

    const rows = Array.from(map.entries()).map(([name, v]) => ({ name, ...v }));
    rows.sort((a,b) =>
      (b.points - a.points) ||
      (b.uploads - a.uploads) ||
      a.name.localeCompare(b.name)
    );

    return rows;
  }

  function renderRankings(rows){
    rankingsList.innerHTML = `
      <div class="rankings-row rankings-head">
        <div>#</div><div>Uploader</div><div class="right">Uploads</div><div class="right">Points</div>
      </div>
    `;

    if (!rows.length){
      rankingsList.innerHTML += `<div class="rankings-empty">No uploads yet.</div>`;
      return;
    }

    rows.forEach((r, i) => {
      rankingsList.innerHTML += `
        <div class="rankings-row">
          <div>${i + 1}</div>
          <div>${escapeHtml(r.name)}</div>
          <div class="right">${r.uploads}</div>
          <div class="right">${Number(r.points || 0).toFixed(1)}</div>
        </div>
      `;
    });
  }

  function openRankings(){
    rankingsModalBackdrop.classList.add("show");
    renderRankings(buildRankings(latestDocsForRankings));
  }
  function closeRankings(){
    rankingsModalBackdrop.classList.remove("show");
  }

  openRankingsBtn.addEventListener("click", openRankings);
  rankingsClose.addEventListener("click", closeRankings);
  rankingsModalBackdrop.addEventListener("click", (e) => {
    if (e.target === rankingsModalBackdrop) closeRankings();
  });

  function openScoringRules(){
    scoringModalBackdrop.classList.add("show");
  }
  function closeScoringRules(){
    scoringModalBackdrop.classList.remove("show");
  }
  rankingsRulesBtn.addEventListener("click", openScoringRules);
  scoringClose.addEventListener("click", closeScoringRules);
  scoringModalBackdrop.addEventListener("click", (e) => {
    if (e.target === scoringModalBackdrop) closeScoringRules();
  });

  // Sorting UI logic
  function setSortMode(mode) {
    sortMode = mode;
    currentPage = 1;
    sortModeLabel.textContent = SORT_LABELS[mode] || "Newest first";
    sortMenu.classList.remove("show");
    renderGallery();
  }

  sortModeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    sortMenu.classList.toggle("show");
  });

  sortMenu.addEventListener("click", (e) => {
    const btn = e.target.closest(".sort-option");
    if (!btn) return;
    const mode = btn.dataset.mode;
    if (!mode) return;
    setSortMode(mode);
  });

  document.addEventListener("click", (e) => {
    if (!sortMenu.classList.contains("show")) return;
    const insideBtn = e.target === sortModeBtn || sortModeBtn.contains(e.target);
    const insideMenu = e.target === sortMenu || sortMenu.contains(e.target);
    if (!insideBtn && !insideMenu) sortMenu.classList.remove("show");
  });

  // Helpers
  function escapeHtml(str) {
    if (typeof str !== "string") return "";
    return str.replace(/[&<>"']/g, (c) => (
      c === "&" ? "&amp;" :
      c === "<" ? "&lt;" :
      c === ">" ? "&gt;" :
      c === '"' ? "&quot;" : "&#039;"
    ));
  }

  function formatTimeAgo(date) {
    const now = new Date();
    const diff = (now.getTime() - date.getTime()) / 1000;
    if (diff < 60) return "Just now";
    const mins = Math.floor(diff / 60);
    if (mins < 60) return `${mins} min${mins === 1 ? "" : "s"} ago`;
    const hours = Math.floor(mins / 60);
    if (hours < 24) return `${hours} hr${hours === 1 ? "" : "s"} ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} day${days === 1 ? "" : "s"} ago`;
    return date.toLocaleDateString();
  }

  function toDDMMYY(d) {
    return d.toLocaleDateString("en-GB", { day: "2-digit", month: "2-digit", year: "2-digit" });
  }
</script>
</body>
</html>
